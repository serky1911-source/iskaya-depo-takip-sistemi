<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo Takip V9.0 (Net)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --bg: #f4f6f8; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Gƒ∞Rƒ∞≈û EKRANI */
        #LoginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: white; padding: 30px; border-radius: 8px; text-align: center; width: 300px; }
        
        /* TABS */
        .tab { display: flex; flex-wrap: wrap; background: #ddd; margin-bottom: 15px; }
        .tab button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; }
        .tab button.active { background: var(--primary); color: white; }
        .tabcontent { display: none; padding: 10px; }
        
        /* FORM ELEMANLARI */
        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        /* TABLOLAR */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: var(--primary); color: white; }
        .kritik { background: #ffebee; color: #c62828; font-weight: bold; }
        
        @media(max-width:600px){ .row{ flex-direction: column; } }
    </style>
</head>
<body>

<div id="LoginScreen">
    <div class="login-box">
        <h2>üîí Giri≈ü</h2>
        <input type="text" id="kadi" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input type="password" id="sifre" placeholder="≈ûifre">
        <button onclick="giris()">Giri≈ü Yap</button>
    </div>
</div>

<div id="Dashboard" style="display: none;">
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üè≠ Depo Y√∂netim</h2>
            <button onclick="location.reload()" style="width:auto; background:var(--danger);">√áƒ±kƒ±≈ü</button>
        </div>

        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Tan')" id="defOpen">üõ†Ô∏è Tanƒ±mlamalar</button>
            <button class="tablinks" onclick="openTab(event, 'Isl')">üì¶ ƒ∞≈ülemler</button>
            <button class="tablinks" onclick="openTab(event, 'Rap')">üìä Raporlar</button>
            <button class="tablinks" onclick="openTab(event, 'Ai')">ü§ñ AI</button>
        </div>

        <div id="Tan" class="tabcontent">
            <div class="row">
                <div class="col"><h3>B√∂l√ºm Ekle</h3><input id="tBolum" placeholder="√ñrn: Ana Depo"><button onclick="ekle('/bolumler/ekle', {bolum_adi: v('tBolum')})">Kaydet</button></div>
                <div class="col"><h3>Personel Ekle</h3><input id="tPer" placeholder="√ñrn: Ali Veli"><button onclick="ekle('/personel/ekle', {ad_soyad: v('tPer')})">Kaydet</button></div>
            </div>
            <hr>
            <h3>√úr√ºn Tanƒ±mla</h3>
            <div class="row">
                <input id="tUrun" placeholder="√úr√ºn Adƒ±">
                <input id="tSku" placeholder="SKU">
                <input id="tBirim" placeholder="Birim (Adet)">
            </div>
            <div class="row">
                <select id="tTur"><option value="Sarf">Sarf</option><option value="Demirba≈ü">Demirba≈ü</option></select>
                <input id="tGuv" type="number" placeholder="G√ºvenlik Stoƒüu">
                <button onclick="ekle('/urunler/ekle', {urun_adi:v('tUrun'), sku:v('tSku'), birim:v('tBirim'), tur:v('tTur'), guvenlik_stogu:v('tGuv')})">√úr√ºn√º Kaydet</button>
            </div>
        </div>

        <div id="Isl" class="tabcontent">
            <h3>Stok Giri≈ü / √áƒ±kƒ±≈ü</h3>
            <select id="iTur"><option value="giris">Mal Kabul (Giri≈ü)</option><option value="cikis">T√ºketim (√áƒ±kƒ±≈ü)</option></select>
            <div class="row">
                <select id="iBolum"><option>B√∂l√ºm Se√ß...</option></select>
                <select id="iUrun"><option>√úr√ºn Se√ß...</option></select>
            </div>
            <input id="iMiktar" type="number" placeholder="Miktar">
            <input id="iBelge" placeholder="A√ßƒ±klama / Belge No">
            <button onclick="islemYap()">ƒ∞≈ülemi Onayla</button>
            
            <hr>
            <h3>Zimmet Verme (Demirba≈ü)</h3>
            <div class="row">
                <select id="zUrun"><option>√úr√ºn...</option></select>
                <select id="zPer"><option>Personel...</option></select>
            </div>
            <div class="row">
                <select id="zBolum"><option>Hangi Depodan?</option></select>
                <input id="zMiktar" type="number" placeholder="Adet" value="1">
            </div>
            <button onclick="zimmetle()" style="background:var(--danger)">Zimmetle</button>
        </div>

        <div id="Rap" class="tabcontent">
            <button onclick="raporCek()" style="background:var(--success); margin-bottom: 20px;">üîÑ Raporlarƒ± Yenile</button>
            
            <h3 style="background:#ddd; padding:5px;">üì¶ Depo Stok Durumu (Sarf & Demirba≈ü)</h3>
            <table>
                <thead><tr><th>B√∂l√ºm</th><th>√úr√ºn (SKU)</th><th>T√ºr</th><th>Mevcut Miktar</th></tr></thead>
                <tbody id="tblStok"></tbody>
            </table>

            <h3 style="background:#ddd; padding:5px; margin-top:30px;">üë∑ Zimmet Listesi (Ki≈üideki E≈üyalar)</h3>
            <table>
                <thead><tr><th>Personel</th><th>√úr√ºn</th><th>Miktar</th><th>Tarih</th></tr></thead>
                <tbody id="tblZimmet"></tbody>
            </table>
        </div>

        <div id="Ai" class="tabcontent">
            <h3>ü§ñ AI Asistan</h3>
            <input id="aiSoru" placeholder="Soru sor...">
            <button onclick="aiSor()">G√∂nder</button>
            <p id="aiCevap" style="background:#eee; padding:10px; border-radius:5px; white-space: pre-wrap;"></p>
        </div>
    </div>
</div>

<script>
    const API = ""; 
    const v = (id) => document.getElementById(id).value;
    
    async function giris() {
        try {
            let res = await fetch(API+'/giris', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({kullanici_adi:v('kadi'), sifre:v('sifre')})});
            if(res.ok) {
                document.getElementById('LoginScreen').style.display='none';
                document.getElementById('Dashboard').style.display='block';
                verileriYukle();
                document.getElementById('defOpen').click();
            } else alert("Hatalƒ±!");
        } catch(e) { alert("Sunucu hatasƒ±!"); }
    }

    async function verileriYukle() {
        let bol = await (await fetch(API+'/bolumler/listele')).json();
        let uru = await (await fetch(API+'/urunler/listele')).json();
        let per = await (await fetch(API+'/personel/listele')).json();
        
        fillSel('iBolum', bol, 'bolum_id', 'bolum_adi'); fillSel('zBolum', bol, 'bolum_id', 'bolum_adi');
        fillSel('iUrun', uru, 'SKU', 'urun_adi'); fillSel('zUrun', uru, 'SKU', 'urun_adi');
        fillSel('zPer', per, 'personel_id', 'ad_soyad');
    }
    
    function fillSel(id, data, val, txt) {
        let el = document.getElementById(id); el.innerHTML='<option value="">Se√ßiniz...</option>';
        data.forEach(d => el.innerHTML += `<option value="${d[val]}">${d[txt]} (${d[val] || d.SKU})</option>`);
    }

    async function ekle(url, data) {
        await fetch(API+url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        alert("Kaydedildi"); verileriYukle();
    }

    async function islemYap() {
        let data = {sku:v('iUrun'), bolum_id:v('iBolum'), miktar:v('iMiktar'), belge_no:v('iBelge')};
        let tur = v('iTur');
        let res = await fetch(API+'/stok/'+tur, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(res.ok) alert("ƒ∞≈ülem Ba≈üarƒ±lƒ±"); else alert("Hata!");
    }

    async function zimmetle() {
        let data = {sku:v('zUrun'), personel_id:v('zPer'), bolum_id:v('zBolum'), miktar:v('zMiktar')};
        let res = await fetch(API+'/zimmet/ver', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(res.ok) alert("Zimmetlendi"); else alert("Hata!");
    }

    async function raporCek() {
        // Stok
        let stok = await (await fetch(API+'/rapor/genel-stok')).json();
        let t1 = "";
        stok.forEach(s => {
            let cls = s.uyari ? 'kritik' : '';
            t1 += `<tr class="${cls}"><td>${s.bolum}</td><td>${s.urun_adi}</td><td>${s.tur}</td><td>${s.mevcut}</td></tr>`;
        });
        document.getElementById('tblStok').innerHTML = t1 || "<tr><td colspan='4'>Veri yok</td></tr>";

        // Zimmet
        let zim = await (await fetch(API+'/rapor/zimmetler')).json();
        let t2 = "";
        zim.forEach(z => {
            t2 += `<tr><td>${z.ad_soyad}</td><td>${z.urun_adi}</td><td>${z.miktar}</td><td>${new Date(z.verilis_tarihi).toLocaleDateString()}</td></tr>`;
        });
        document.getElementById('tblZimmet').innerHTML = t2 || "<tr><td colspan='4'>Zimmet yok</td></tr>";
    }

    async function aiSor() {
        document.getElementById('aiCevap').innerText = "D√º≈ü√ºn√ºyor...";
        let res = await fetch(API+'/ai/sor', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({soru:v('aiSoru')})});
        let d = await res.json();
        document.getElementById('aiCevap').innerText = d.cevap;
    }

    function openTab(evt, name) {
        document.querySelectorAll('.tabcontent').forEach(x => x.style.display='none');
        document.querySelectorAll('.tablinks').forEach(x => x.classList.remove('active'));
        document.getElementById(name).style.display='block';
        evt.currentTarget.classList.add('active');
    }
</script>
</body>
</html>