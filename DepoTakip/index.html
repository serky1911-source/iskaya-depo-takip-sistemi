<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kurumsal Depo V1.0</title>
    <style>
        :root { --primary: #0d6efd; --dark: #212529; --light: #f8f9fa; --success: #198754; --danger: #dc3545; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; display: flex; height: 100vh; background: #e9ecef; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--dark); color: white; display: flex; flex-direction: column; }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #444; background: #1a1e21; }
        .menu { flex: 1; padding: 10px; }
        .menu button { display: block; width: 100%; padding: 12px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; border-radius: 5px; margin-bottom: 5px; }
        .menu button:hover, .menu button.active { background: var(--primary); color: white; }
        
        /* CONTENT */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; color: var(--dark); border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block; }
        
        /* FORMS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        button.btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        
        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f1f3f5; color: var(--dark); }
        
        .hidden { display: none; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: white; }
        .bg-green { background: var(--success); } .bg-red { background: var(--danger); }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand">ğŸ­ DEPO PRO</div>
    <div class="menu">
        <button onclick="show('p-dashboard')" class="active">ğŸ“Š Genel BakÄ±ÅŸ</button>
        <button onclick="show('p-tanim')">ğŸ› ï¸ TanÄ±mlamalar</button>
        <button onclick="show('p-sarf')">ğŸ“¦ Sarf Ä°ÅŸlemleri</button>
        <button onclick="show('p-demirbas')">ğŸ’» DemirbaÅŸ Ä°ÅŸlemleri</button>
        <button onclick="show('p-rapor')">ğŸ“ˆ Raporlar</button>
    </div>
</div>

<div class="main">
    
    <div id="p-dashboard" class="page">
        <div class="card">
            <h2>HoÅŸgeldiniz</h2>
            <p>Sistem V1.0 Aktif. Sol menÃ¼den iÅŸlem seÃ§iniz.</p>
            <div class="form-grid">
                <div style="background:#e3f2fd; padding:15px; border-radius:5px;">
                    <h3>Sarf Malzeme</h3>
                    <p>Miktar bazlÄ± takip edilir. GiriÅŸ/Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±r.</p>
                </div>
                <div style="background:#fce4ec; padding:15px; border-radius:5px;">
                    <h3>DemirbaÅŸ</h3>
                    <p>Tekil kod (Barkod) ile takip edilir. Zimmetlenir.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="p-tanim" class="page hidden">
        <div class="card">
            <h2>Yeni ÃœrÃ¼n TanÄ±mla</h2>
            <div class="form-grid">
                <div><label>ÃœrÃ¼n AdÄ±</label><input id="t-name"></div>
                <div><label>TÃ¼r</label><select id="t-type"><option value="SARF">Sarf Malzemesi</option><option value="DEMIRBAS">DemirbaÅŸ</option></select></div>
                <div><label>Birim</label><select id="t-unit"></select></div>
                <div><label>Min. Limit</label><input type="number" id="t-min" value="0"></div>
            </div>
            <button class="btn btn-primary" onclick="createProduct()">Kaydet</button>
        </div>
        <div class="card">
            <h2>Personel Ekle</h2>
            <div class="form-grid">
                <div><label>Ad Soyad</label><input id="p-name"></div>
                <div><label>BÃ¶lÃ¼m</label><select id="p-dept"></select></div>
                <div><button class="btn btn-success" style="margin-top:24px" onclick="createPersonel()">Ekle</button></div>
            </div>
        </div>
    </div>

    <div id="p-sarf" class="page hidden">
        <div class="card">
            <h2>ğŸ“¥ Sarf GiriÅŸi (Mal Kabul)</h2>
            <div class="form-grid">
                <div><label>ÃœrÃ¼n SeÃ§</label><select id="sg-prod"></select></div>
                <div><label>Miktar</label><input type="number" id="sg-qty"></div>
                <div><label>AÃ§Ä±klama</label><input id="sg-desc"></div>
                <div><button class="btn btn-success" style="margin-top:24px" onclick="sarfGiris()">GiriÅŸ Yap</button></div>
            </div>
        </div>
        <div class="card">
            <h2>ğŸ“¤ Sarf Ã‡Ä±kÄ±ÅŸÄ± (TÃ¼ketim)</h2>
            <div class="form-grid">
                <div><label>ÃœrÃ¼n SeÃ§</label><select id="sc-prod"></select></div>
                <div><label>GideceÄŸi BÃ¶lÃ¼m</label><select id="sc-dept"></select></div>
                <div><label>Miktar</label><input type="number" id="sc-qty"></div>
                <div><button class="btn btn-danger" style="margin-top:24px" onclick="sarfCikis()">Ã‡Ä±kÄ±ÅŸ Yap</button></div>
            </div>
        </div>
    </div>

    <div id="p-demirbas" class="page hidden">
        <div class="card">
            <h2>ğŸ“¥ DemirbaÅŸ KaydÄ± (StoÄŸa Al)</h2>
            <div class="form-grid">
                <div><label>DemirbaÅŸ SeÃ§</label><select id="dg-prod"></select></div>
                <div><label>Adet (KaÃ§ tane geldi?)</label><input type="number" id="dg-qty" value="1"></div>
                <div><button class="btn btn-success" style="margin-top:24px" onclick="demirbasGiris()">Kimliklendir ve Kaydet</button></div>
            </div>
            <small>Not: Girilen adet kadar benzersiz kod (DMB-XXX) Ã¼retilecektir.</small>
        </div>
        
        <div class="card">
            <h2>ğŸ‘¤ Zimmet Ver (Personele)</h2>
            <div class="form-grid">
                <div><label>Depodaki DemirbaÅŸlar</label><select id="zv-item"></select></div>
                <div><label>Personel</label><select id="zv-pers"></select></div>
                <div><button class="btn btn-primary" style="margin-top:24px" onclick="zimmetVer()">Zimmetle</button></div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ”„ Zimmet Ä°ade Al</h2>
            <div class="form-grid">
                <div><label>Zimmetli ÃœrÃ¼nler</label><select id="zi-assign"></select></div>
                <div><label>Durum</label><select id="zi-cond"><option value="SAGLAM">SaÄŸlam (Depoya)</option><option value="ARIZALI">ArÄ±zalÄ± (Depoya)</option><option value="HURDA">HURDA (Ã‡Ã¶pe)</option></select></div>
                <div><button class="btn btn-danger" style="margin-top:24px" onclick="zimmetIade()">Ä°ade Al</button></div>
            </div>
        </div>
    </div>

    <div id="p-rapor" class="page hidden">
        <div class="card">
            <button class="btn btn-primary" onclick="loadReports()">RaporlarÄ± Yenile</button>
        </div>
        <div class="card">
            <h3>ğŸ“¦ Sarf Stok Durumu</h3>
            <table><thead><tr><th>ÃœrÃ¼n</th><th>Birim</th><th>Mevcut Stok</th></tr></thead><tbody id="tbl-sarf"></tbody></table>
        </div>
        <div class="card">
            <h3>ğŸ’» DemirbaÅŸ Envanteri</h3>
            <table><thead><tr><th>ÃœrÃ¼n</th><th>Durum</th><th>Adet</th></tr></thead><tbody id="tbl-dmb"></tbody></table>
        </div>
    </div>

</div>

<script>
    const API = "/api";
    
    // --- NAVIGATION ---
    function show(id) {
        document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.menu button').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        if(id !== 'p-dashboard') loadData(); // Verileri tazeleyen fonksiyon
    }

    // --- DATA LOADING ---
    async function loadData() {
        // ReferanslarÄ± Ã‡ek
        const refs = await (await fetch(API+'/refs')).json();
        
        // Dropdown Doldurma YardÄ±mcÄ±sÄ±
        const fill = (id, data, valKey='id', txtKey='name') => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">SeÃ§iniz...</option>';
            data.forEach(item => el.innerHTML += `<option value="${item[valKey]}">${item[txtKey]}</option>`);
        };

        fill('t-unit', refs.units, 'code', 'name');
        fill('p-dept', refs.depts);
        fill('sc-dept', refs.depts);
        fill('zv-pers', refs.personnel, 'id', 'full_name');

        // ÃœrÃ¼nleri Ã‡ek (TÃ¼rÃ¼ne GÃ¶re)
        const sarf = await (await fetch(API+'/products/SARF')).json();
        const demirbas = await (await fetch(API+'/products/DEMIRBAS')).json();
        
        fill('sg-prod', sarf);
        fill('sc-prod', sarf);
        fill('dg-prod', demirbas);

        // Depodaki DemirbaÅŸlarÄ± Ã‡ek
        const depodakiler = await (await fetch(API+'/demirbas/list/depo')).json();
        const elD = document.getElementById('zv-item');
        elD.innerHTML = '<option value="">SeÃ§iniz...</option>';
        depodakiler.forEach(x => elD.innerHTML += `<option value="${x.id}">${x.name} (${x.demirbas_code})</option>`);

        // Zimmetlileri Ã‡ek
        const zimmetliler = await (await fetch(API+'/zimmet/active')).json();
        const elZ = document.getElementById('zi-assign');
        elZ.innerHTML = '<option value="">SeÃ§iniz...</option>';
        zimmetliler.forEach(x => elZ.innerHTML += `<option value="${x.assignment_id}">${x.full_name} -> ${x.product_name} (${x.demirbas_code})</option>`);
    }

    // --- ACTIONS ---
    async function createProduct() {
        const body = {
            name: document.getElementById('t-name').value,
            type_code: document.getElementById('t-type').value,
            unit_code: document.getElementById('t-unit').value,
            min_limit: parseInt(document.getElementById('t-min').value)
        };
        const res = await fetch(API+'/products', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) { alert('ÃœrÃ¼n Eklendi'); loadData(); } else alert('Hata!');
    }

    async function createPersonel() {
        const body = {
            full_name: document.getElementById('p-name').value,
            department_id: parseInt(document.getElementById('p-dept').value)
        };
        const res = await fetch(API+'/personel', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) { alert('Personel Eklendi'); loadData(); } else alert('Hata!');
    }

    async function sarfGiris() {
        const body = {
            product_id: parseInt(document.getElementById('sg-prod').value),
            quantity: parseFloat(document.getElementById('sg-qty').value),
            description: document.getElementById('sg-desc').value
        };
        const res = await fetch(API+'/sarf/giris', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) alert('GiriÅŸ YapÄ±ldÄ±'); else alert('Hata: ' + (await res.json()).detail);
    }

    async function sarfCikis() {
        const body = {
            product_id: parseInt(document.getElementById('sc-prod').value),
            department_id: parseInt(document.getElementById('sc-dept').value),
            quantity: parseFloat(document.getElementById('sc-qty').value)
        };
        const res = await fetch(API+'/sarf/cikis', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) alert('Ã‡Ä±kÄ±ÅŸ YapÄ±ldÄ±'); else alert('Hata: ' + (await res.json()).detail);
    }

    async function demirbasGiris() {
        const body = {
            product_id: parseInt(document.getElementById('dg-prod').value),
            quantity: parseFloat(document.getElementById('dg-qty').value)
        };
        const res = await fetch(API+'/demirbas/giris', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) { alert((await res.json()).msg); loadData(); } else alert('Hata');
    }

    async function zimmetVer() {
        const body = {
            demirbas_item_id: parseInt(document.getElementById('zv-item').value),
            personel_id: parseInt(document.getElementById('zv-pers').value)
        };
        const res = await fetch(API+'/zimmet/ver', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) { alert('Zimmetlendi'); loadData(); } else alert('Hata: ' + (await res.json()).detail);
    }

    async function zimmetIade() {
        const body = {
            assignment_id: parseInt(document.getElementById('zi-assign').value),
            condition: document.getElementById('zi-cond').value
        };
        const res = await fetch(API+'/zimmet/iade', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) { alert('Ä°ade AlÄ±ndÄ±'); loadData(); } else alert('Hata');
    }

    async function loadReports() {
        const s = await (await fetch(API+'/reports/sarf')).json();
        document.getElementById('tbl-sarf').innerHTML = s.map(x => `<tr><td>${x.name}</td><td>${x.unit}</td><td><b>${x.stock}</b></td></tr>`).join('');

        const d = await (await fetch(API+'/reports/demirbas')).json();
        document.getElementById('tbl-dmb').innerHTML = d.map(x => `<tr><td>${x.name}</td><td>${x.status}</td><td>${x.count}</td></tr>`).join('');
    }

    // Ä°lk YÃ¼kleme
    loadData();
</script>

</body>
</html>