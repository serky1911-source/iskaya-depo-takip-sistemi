<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo V13 (Stabil)</title>
    <style>
        :root { --p: #2c3e50; --s: #34495e; --a: #3498db; --d: #e74c3c; --g: #27ae60; --bg: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        
        /* GÄ°RÄ°Å */
        #Login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--p); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .box { background: white; padding: 30px; border-radius: 8px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .box input, .box button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .box button { background: var(--a); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* PANEL */
        #Panel { display: none; max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: var(--p); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* SEKMELER */
        .tabs { display: flex; background: #ddd; }
        .tabs button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #555; transition: 0.3s; }
        .tabs button:hover { background: #ccc; }
        .tabs button.active { background: white; color: var(--a); border-top: 3px solid var(--a); }
        .page { display: none; padding: 20px; } .active-page { display: block; }
        
        /* Ä°Ã‡ERÄ°K */
        .row { display: flex; gap: 15px; margin-bottom: 15px; } .col { flex: 1; }
        input, select, button { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        button { background: var(--a); color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .btn-green { background: var(--g); } .btn-red { background: var(--d); }
        
        /* TABLO */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: var(--s); color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        .kritik { background: #ffcccc; font-weight: bold; color: #a00; }
        
        @media(max-width: 600px) { .row { flex-direction: column; } .tabs { flex-wrap: wrap; } }
    </style>
</head>
<body>

<div id="Login">
    <div class="box">
        <h2>ğŸ”’ GiriÅŸ</h2>
        <input id="kadi" placeholder="KullanÄ±cÄ± AdÄ±">
        <input id="sifre" type="password" placeholder="Åifre">
        <button onclick="giris()">GiriÅŸ Yap</button>
        <p id="msg" style="color:red; font-size:0.9rem; margin-top:10px;"></p>
    </div>
</div>

<div id="Panel">
    <header><h3>ğŸ­ Depo YÃ¶netim</h3><button onclick="location.reload()" style="width:auto; background:var(--d); padding:8px 15px;">Ã‡Ä±kÄ±ÅŸ</button></header>
    <div class="tabs">
        <button onclick="tab('p1')" class="active">ğŸ› ï¸ TanÄ±m</button>
        <button onclick="tab('p2')">ğŸ“¦ Ä°ÅŸlem</button>
        <button onclick="tab('p3')" onclick="raporla()">ğŸ“Š Rapor</button>
        <button onclick="tab('p4')">ğŸ¤– AI</button>
    </div>

    <div id="p1" class="page active-page">
        <div class="row">
            <div class="col"><h4>BÃ¶lÃ¼m Ekle</h4><input id="tb" placeholder="Ad"><button onclick="ekle('bolum',{ad:v('tb')})">Kaydet</button></div>
            <div class="col"><h4>Personel Ekle</h4><input id="tp" placeholder="Ad Soyad"><button onclick="ekle('personel',{ad:v('tp')})">Kaydet</button></div>
        </div>
        <hr>
        <h4>ÃœrÃ¼n TanÄ±mla</h4>
        <div class="row"><input id="ua" placeholder="ÃœrÃ¼n AdÄ±"><input id="us" placeholder="SKU"><input id="ub" placeholder="Birim"></div>
        <div class="row"><select id="ut"><option>Sarf</option><option>DemirbaÅŸ</option></select><input id="ug" type="number" placeholder="GÃ¼v. Stok"><button onclick="ekle('urun',{ad:v('ua'),sku:v('us'),birim:v('ub'),tur:v('ut'),guvenlik:v('ug')})">Kaydet</button></div>
        <div style="margin-top:20px; border:2px dashed green; padding:10px;">
            <h4>ğŸ“¥ Excel YÃ¼kle</h4><input type="file" id="xls" style="background:white"><button onclick="excel()" class="btn-green" style="margin-top:5px;">YÃ¼kle</button>
        </div>
    </div>

    <div id="p2" class="page">
        <div class="row">
            <div class="col" style="border:1px solid #ddd; padding:15px; border-radius:5px;">
                <h4 style="color:var(--a)">GiriÅŸ / Ã‡Ä±kÄ±ÅŸ (Sarf)</h4>
                <select id="itip"><option value="GIRIS">Mal Kabul (GiriÅŸ)</option><option value="CIKIS">TÃ¼ketim (Ã‡Ä±kÄ±ÅŸ)</option></select>
                <div class="row" style="margin:10px 0;"><select id="iu"></select><select id="ib"></select></div>
                <input id="im" type="number" placeholder="Miktar"><input id="ia" placeholder="AÃ§Ä±klama" style="margin-top:10px;">
                <button onclick="hareket()" style="margin-top:10px;">Ä°ÅŸlemi Onayla</button>
            </div>
            <div class="col" style="border:1px solid #ddd; padding:15px; border-radius:5px;">
                <h4 style="color:var(--d)">Zimmet (DemirbaÅŸ)</h4>
                <select id="zu"></select><select id="zb" style="margin-top:10px;"><option>Hangi Depodan?</option></select>
                <select id="zp" style="margin-top:10px;"></select><input id="zm" type="number" value="1" style="margin-top:10px;">
                <button onclick="zimmet()" class="btn-red" style="margin-top:10px;">Zimmetle</button>
            </div>
        </div>
    </div>

    <div id="p3" class="page">
        <div style="background:#f9f9f9; padding:15px; border:1px solid #ddd; margin-bottom:20px;">
            <h4>ğŸ” Tarih AralÄ±ÄŸÄ± SeÃ§</h4>
            <div class="row">
                <input type="date" id="t1">
                <input type="date" id="t2">
                <button onclick="raporla()" class="btn-green">Raporu Getir</button>
            </div>
        </div>

        <h4 style="border-bottom:2px solid var(--a); padding-bottom:5px;">ğŸ“¦ Mevcut Depo StoÄŸu (Net)</h4>
        <table id="trStok"><thead><tr><th>Depo</th><th>ÃœrÃ¼n</th><th>SKU</th><th>TÃ¼r</th><th>Miktar</th><th>Durum</th></tr></thead><tbody></tbody></table>

        <h4 style="border-bottom:2px solid var(--d); padding-bottom:5px; margin-top:30px;">ğŸ‘· Zimmet Listesi</h4>
        <table id="trZim"><thead><tr><th>Personel</th><th>ÃœrÃ¼n</th><th>Miktar</th><th>Tarih</th></tr></thead><tbody></tbody></table>

        <h4 style="border-bottom:2px solid #555; padding-bottom:5px; margin-top:30px;">ğŸ“œ Hareket DÃ¶kÃ¼mÃ¼ (SeÃ§ilen Tarih)</h4>
        <table id="trHar"><thead><tr><th>Tarih</th><th>Ä°ÅŸlem</th><th>Depo</th><th>ÃœrÃ¼n</th><th>Miktar</th><th>AÃ§Ä±klama</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p4" class="page">
        <div style="text-align:center; max-width:600px; margin:0 auto;">
            <h3>ğŸ¤– Depo AsistanÄ±</h3>
            <input id="aiq" placeholder="Soru sor..."><button onclick="ai()" style="margin-top:10px;">GÃ¶nder</button>
            <div id="air" style="background:#eee; padding:15px; margin-top:20px; text-align:left; border-radius:5px;">...</div>
        </div>
    </div>
</div>

<script>
    const API = "/api"; const v = id => document.getElementById(id).value;
    
    // Tarihleri ayarla (Son 30 gÃ¼n)
    const today = new Date().toISOString().split('T')[0];
    const prev = new Date(); prev.setDate(prev.getDate()-30);
    document.getElementById('t1').value = prev.toISOString().split('T')[0];
    document.getElementById('t2').value = today;

    async function giris() {
        try {
            let r = await fetch(API+'/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({kadi:v('kadi'), sifre:v('sifre')})});
            if(r.ok) { document.getElementById('Login').style.display='none'; document.getElementById('Panel').style.display='block'; init(); }
            else document.getElementById('msg').innerText = "HatalÄ± GiriÅŸ!";
        } catch(e) { alert("Sunucu HatasÄ±"); }
    }

    async function init() {
        let b = await(await fetch(API+'/list/bolum')).json();
        let p = await(await fetch(API+'/list/personel')).json();
        let u = await(await fetch(API+'/list/urun')).json();
        
        fill('ib', b); fill('zb', b);
        fill('iu', u, true); fill('zu', u, true); // True = ÃœrÃ¼n
        fill('zp', p);
    }
    
    function fill(id, arr, isUrun=false) {
        let el = document.getElementById(id); el.innerHTML='<option value="">SeÃ§iniz...</option>';
        arr.forEach(x => {
            let val = x.id; let txt = isUrun ? `${x.ad} (${x.sku})` : (x.ad || x.ad_soyad);
            el.innerHTML += `<option value="${val}">${txt}</option>`;
        });
    }

    async function ekle(path, data) {
        let r = await fetch(API+'/ekle/'+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(r.ok) { alert("Eklendi"); init(); } else alert("Hata");
    }

    async function hareket() {
        let r = await fetch(API+'/hareket', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tip:v('itip'), urun_id:v('iu'), bolum_id:v('ib'), miktar:v('im'), aciklama:v('ia')})});
        if(r.ok) { alert("Kaydedildi"); raporla(); } else alert((await r.json()).detail);
    }

    async function zimmet() {
        let r = await fetch(API+'/zimmet', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({urun_id:v('zu'), personel_id:v('zp'), bolum_id:v('zb'), miktar:v('zm')})});
        if(r.ok) { alert("Zimmetlendi"); raporla(); } else alert((await r.json()).detail); // Hata mesajÄ±nÄ± gÃ¶ster (Sarf uyarÄ±sÄ± buraya dÃ¼ÅŸer)
    }

    async function excel() {
        let fd = new FormData(); fd.append("file", document.getElementById('xls').files[0]);
        let r = await fetch(API+'/admin/excel', {method:'POST', body:fd});
        alert((await r.json()).msg); init();
    }

    async function raporla() {
        let r = await fetch(API+'/rapor/stok', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({baslangic:v('t1'), bitis:v('t2')})});
        let d = await r.json();
        
        // Stok Tablosu
        let h1=""; d.stok.forEach(x => {
            let cls = (x.tur=='Sarf' && x.mevcut<=x.guvenlik_stogu) ? 'kritik' : '';
            h1+=`<tr class="${cls}"><td>${x.bolum}</td><td>${x.urun}</td><td>${x.sku}</td><td>${x.tur}</td><td>${x.mevcut}</td><td>${cls?'KRÄ°TÄ°K':'Normal'}</td></tr>`
        });
        document.querySelector('#trStok tbody').innerHTML = h1 || "<tr><td colspan='6'>Veri Yok</td></tr>";

        // Hareket Tablosu
        let h2=""; d.hareketler.forEach(x => {
            h2+=`<tr><td>${new Date(x.tarih).toLocaleString()}</td><td>${x.islem_tipi}</td><td>${x.bolum}</td><td>${x.urun}</td><td>${x.miktar}</td><td>${x.aciklama}</td></tr>`
        });
        document.querySelector('#trHar tbody').innerHTML = h2 || "<tr><td colspan='6'>Bu tarihlerde hareket yok</td></tr>";

        // Zimmet Tablosu
        let z = await(await fetch(API+'/rapor/zimmet')).json();
        let h3=""; z.forEach(x => h3+=`<tr><td>${x.ad_soyad}</td><td>${x.urun}</td><td>${x.miktar}</td><td>${new Date(x.tarih).toLocaleDateString()}</td></tr>`);
        document.querySelector('#trZim tbody').innerHTML = h3 || "<tr><td colspan='4'>Zimmet Yok</td></tr>";
    }

    async function ai() {
        document.getElementById('air').innerText="...";
        let r = await fetch(API+'/ai', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({soru:v('aiq')})});
        document.getElementById('air').innerText=(await r.json()).cevap;
    }

    function tab(id) {
        document.querySelectorAll('.page').forEach(x=>x.style.display='none');
        document.querySelectorAll('.tabs button').forEach(x=>x.classList.remove('active'));
        document.getElementById(id).style.display='block';
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>