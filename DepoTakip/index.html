<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo V16 Final</title>
    <style>
        :root { --p: #2c3e50; --s: #34495e; --a: #3498db; --d: #e74c3c; --g: #27ae60; --bg: #ecf0f1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        #Login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--p); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .box { background: white; padding: 30px; border-radius: 8px; width: 300px; text-align: center; }
        .box input, .box button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .box button { background: var(--a); color: white; border: none; font-weight: bold; cursor: pointer; }
        #Panel { display: none; max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: var(--p); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .tabs { display: flex; background: #ddd; }
        .tabs button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #555; }
        .tabs button.active { background: white; color: var(--a); border-top: 3px solid var(--a); }
        .page { display: none; padding: 20px; } .active-page { display: block; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; } .col { flex: 1; }
        input, select, button { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: var(--a); color: white; border: none; cursor: pointer; font-weight: bold; }
        .btn-green { background: var(--g); } .btn-red { background: var(--d); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: var(--s); color: white; }
        .kritik { background: #ffcccc; font-weight: bold; color: #a00; }
        @media(max-width: 600px) { .row { flex-direction: column; } .tabs { flex-wrap: wrap; } }
    </style>
</head>
<body>

<div id="Login">
    <div class="box">
        <h2>ğŸ”’ GiriÅŸ</h2>
        <input id="kadi" placeholder="KullanÄ±cÄ± AdÄ±">
        <input id="sifre" type="password" placeholder="Åifre">
        <button onclick="giris()">GiriÅŸ Yap</button>
        <p id="msg" style="color:red; font-size:0.9rem; margin-top:10px;"></p>
    </div>
</div>

<div id="Panel">
    <header><h3>ğŸ­ Depo YÃ¶netim V16</h3><button onclick="location.reload()" style="width:auto; background:var(--d); padding:8px 15px;">Ã‡Ä±kÄ±ÅŸ</button></header>
    <div class="tabs">
        <button onclick="tab('p1')" class="active">ğŸ› ï¸ TanÄ±m</button>
        <button onclick="tab('p2')">ğŸ“¥ GiriÅŸ & Transfer</button>
        <button onclick="tab('p3')">ğŸ“¤ Ã‡Ä±kÄ±ÅŸ & Zimmet</button>
        <button onclick="tab('p4')">ğŸ“Š Rapor</button>
    </div>

    <div id="p1" class="page active-page">
        <div class="row">
            <div class="col"><h4>BÃ¶lÃ¼m Ekle</h4><input id="tb" placeholder="Ã–rn: Kaynak AtÃ¶lyesi"><button onclick="ekle('bolum',{ad:v('tb')})">Kaydet</button></div>
            <div class="col"><h4>Personel Ekle</h4><input id="tp" placeholder="Ad Soyad"><button onclick="ekle('personel',{ad:v('tp')})">Kaydet</button></div>
        </div>
        <hr>
        <h4>ÃœrÃ¼n TanÄ±mla</h4>
        <div class="row"><input id="ua" placeholder="ÃœrÃ¼n AdÄ±"><input id="us" placeholder="SKU"><input id="ub" placeholder="Birim"></div>
        <div class="row"><select id="ut"><option value="SARF">SARF MALZEME</option><option value="DEMIRBAS">DEMÄ°RBAÅ</option></select><input id="ug" type="number" placeholder="GÃ¼v. Stok"><button onclick="ekle('urun',{ad:v('ua'),sku:v('us'),birim:v('ub'),tur:v('ut'),guvenlik:v('ug')})" class="btn-green">Kaydet</button></div>
        <div style="margin-top:20px; border:2px dashed green; padding:10px;"><h4>ğŸ“¥ Excel YÃ¼kle</h4><input type="file" id="xls" style="background:white"><button onclick="excel()" class="btn-green" style="margin-top:5px;">YÃ¼kle</button></div>
    </div>

    <div id="p2" class="page">
        <div class="section" style="border:1px solid #ddd; padding:15px; margin-bottom:20px;">
            <h4 style="color:var(--g)">ğŸ“¥ Mal Kabul (SatÄ±n Alma)</h4>
            <div class="row"><select id="gi_u"><option>ÃœrÃ¼n SeÃ§...</option></select><select id="gi_d"><option>Girecek Depo...</option></select></div>
            <div class="row"><input id="gi_m" type="number" placeholder="Miktar"><input id="gi_a" placeholder="AÃ§Ä±klama"><button onclick="girisYap()" class="btn-green">StoÄŸa Ekle</button></div>
        </div>
        
        <div class="section" style="border:1px solid #ddd; padding:15px; border-left: 5px solid #f39c12;">
            <h4 style="color:#e67e22">ğŸšš Depolar ArasÄ± Transfer (Sarf)</h4>
            <select id="tu" style="margin-bottom:10px;"></select>
            <div class="row"><select id="tc"><option>Kaynak Depo</option></select><select id="tg"><option>Hedef Depo</option></select></div>
            <div class="row"><input id="tm" type="number" placeholder="Miktar"><input id="ta" placeholder="AÃ§Ä±klama"><button onclick="transfer()" style="background:#e67e22;">Transfer Et</button></div>
        </div>
    </div>

    <div id="p3" class="page">
        <div style="border-left: 5px solid var(--a); padding:10px; margin-bottom:20px;">
            <h4 style="color:var(--a)">ğŸ“¦ Sarf Ã‡Ä±kÄ±ÅŸÄ± (TÃ¼ketim)</h4>
            <div class="row"><select id="ci_u"></select><select id="ci_d"></select></div>
            <div class="row"><input id="ci_m" type="number" placeholder="Miktar"><input id="ci_a" placeholder="Nereye?"><button onclick="cikisYap()" style="background:var(--a);">Ã‡Ä±kÄ±ÅŸ Yap</button></div>
        </div>
        <div style="border-left: 5px solid var(--d); padding:10px;">
            <h4 style="color:var(--d)">ğŸ‘· DemirbaÅŸ Zimmet</h4>
            <div style="background:#fff0f0; padding:10px; margin-bottom:10px;">
                <h5>â¬‡ï¸ Zimmet Ver</h5>
                <div class="row"><select id="zv_u"></select><select id="zv_d"></select><select id="zv_p"></select></div>
                <div class="row"><input id="zv_m" type="number" value="1"><button onclick="zimmetVer()" class="btn-red">Zimmetle</button></div>
            </div>
            <div style="background:#f0fff0; padding:10px;">
                <h5 style="color:green;">â¬†ï¸ Ä°ade Al</h5>
                <div class="row"><select id="zi_u"></select><select id="zi_p"></select><select id="zi_d"></select></div>
                <div class="row"><select id="zi_durum"><option value="SAGLAM">SAÄLAM</option><option value="ARIZALI">ARIZALI</option><option value="HURDA">HURDA</option></select><button onclick="zimmetAl()" class="btn-green">Ä°ade Al</button></div>
            </div>
        </div>
    </div>

    <div id="p4" class="page">
        <div style="background:#f9f9f9; padding:10px; border:1px solid #ddd; margin-bottom:20px;">
            <h4>ğŸ” Tarih AralÄ±ÄŸÄ±</h4>
            <div class="row"><input type="date" id="t1"><input type="date" id="t2"><button onclick="raporla()" class="btn-green">Rapor Getir</button></div>
        </div>
        <h4>ğŸ“¦ Depo StoklarÄ± (Net)</h4><table id="trStok"><thead><tr><th>Depo</th><th>ÃœrÃ¼n</th><th>SKU</th><th>Miktar</th><th>Durum</th></tr></thead><tbody></tbody></table>
        <h4 style="margin-top:30px;">ğŸ‘· Aktif Zimmetler</h4><table id="trZim"><thead><tr><th>Personel</th><th>ÃœrÃ¼n</th><th>Miktar</th></tr></thead><tbody></tbody></table>
        <h4 style="margin-top:30px;">ğŸ“œ Hareket GeÃ§miÅŸi (Tarihli)</h4><table id="trHar"><thead><tr><th>Tarih</th><th>Ä°ÅŸlem</th><th>Depo</th><th>ÃœrÃ¼n</th><th>Miktar</th><th>AÃ§Ä±klama</th></tr></thead><tbody></tbody></table>
    </div>
</div>

<script>
    const API = "/api"; const v = id => document.getElementById(id).value;
    document.getElementById('t1').value = new Date(Date.now()-30*86400000).toISOString().split('T')[0];
    document.getElementById('t2').value = new Date().toISOString().split('T')[0];

    async function giris() {
        try {
            let r = await fetch(API+'/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({kadi:v('kadi'), sifre:v('sifre')})});
            if(r.ok) { document.getElementById('Login').style.display='none'; document.getElementById('Panel').style.display='block'; init(); }
            else document.getElementById('msg').innerText = "HatalÄ± GiriÅŸ!";
        } catch(e) { alert("Sunucu HatasÄ±"); }
    }

    async function init() {
        let b = await(await fetch(API+'/list/bolum')).json();
        let p = await(await fetch(API+'/list/personel')).json();
        let u = await(await fetch(API+'/list/urun')).json();
        let u_sarf = await(await fetch(API+'/list/urun_sarf')).json();
        let u_demir = await(await fetch(API+'/list/urun_demirbas')).json();

        fill('gi_d', b); fill('ci_d', b); fill('zv_d', b); fill('zi_d', b); fill('tc', b); fill('tg', b);
        fill('gi_u', u, true); fill('tu', u_sarf, true); 
        fill('ci_u', u_sarf, true); 
        fill('zv_u', u_demir, true); fill('zi_u', u_demir, true); 
        fill('zv_p', p); fill('zi_p', p);
    }
    
    function fill(id, arr, isProd=false) {
        let el = document.getElementById(id); let def = el.options[0] ? el.options[0].text : 'SeÃ§iniz';
        el.innerHTML=`<option>${def}</option>`;
        arr.forEach(x => { let txt = isProd ? `${x.ad} (${x.sku})` : (x.ad || x.ad_soyad); el.innerHTML += `<option value="${x.id}">${txt}</option>`; });
    }

    async function ekle(path, data) {
        let r = await fetch(API+'/ekle/'+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(r.ok) { alert("Eklendi"); init(); } else alert("Hata");
    }

    async function girisYap() {
        let r = await fetch(API+'/islem/giris', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({urun_id:v('gi_u'), depo_id:v('gi_d'), miktar:v('gi_m'), aciklama:v('gi_a')})});
        if(r.ok) { alert("GiriÅŸ YapÄ±ldÄ±"); raporla(); } else alert("Hata");
    }

    async function transfer() {
        let r = await fetch(API+'/islem/transfer', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({urun_id:v('tu'), cikis_depo_id:v('tc'), giris_depo_id:v('tg'), miktar:v('tm'), aciklama:v('ta')})});
        if(r.ok) { alert("Transfer YapÄ±ldÄ±"); raporla(); } else alert((await r.json()).detail);
    }

    async function cikisYap() {
        let r = await fetch(API+'/islem/cikis', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({urun_id:v('ci_u'), bolum_id:v('ci_d'), miktar:v('ci_m'), aciklama:v('ci_a')})});
        if(r.ok) { alert("Ã‡Ä±kÄ±ÅŸ YapÄ±ldÄ±"); raporla(); } else alert((await r.json()).detail);
    }

    async function zimmetVer() {
        let r = await fetch(API+'/islem/zimmet_ver', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({urun_id:v('zv_u'), personel_id:v('zv_p'), bolum_id:v('zv_d'), miktar:v('zv_m'), aciklama: "Zimmet Verildi"})});
        if(r.ok) { alert("Zimmetlendi"); raporla(); } else alert((await r.json()).detail);
    }

    async function zimmetAl() {
        let r = await fetch(API+'/islem/zimmet_al', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({urun_id:v('zi_u'), personel_id:v('zi_p'), depo_id:v('zi_d'), miktar:1, durum:v('zi_durum'), aciklama: "Ä°ade"})});
        if(r.ok) { alert("Ä°ade AlÄ±ndÄ±"); raporla(); } else alert((await r.json()).detail);
    }

    async function excel() {
        let fd = new FormData(); fd.append("file", document.getElementById('xls').files[0]);
        let r = await fetch(API+'/admin/excel', {method:'POST', body:fd});
        alert((await r.json()).msg); init();
    }

    async function raporla() {
        let r = await fetch(API+'/rapor/stok', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({baslangic:v('t1'), bitis:v('t2')})});
        let d = await r.json();
        
        let h1=""; d.stok.forEach(x => {
            let cls = (x.tur=='Sarf' && x.mevcut<=x.guvenlik_stogu) ? 'kritik' : '';
            h1+=`<tr class="${cls}"><td>${x.bolum}</td><td>${x.urun}</td><td>${x.sku}</td><td>${x.mevcut}</td><td>${cls?'KRÄ°TÄ°K':'OK'}</td></tr>`
        });
        document.querySelector('#trStok tbody').innerHTML = h1 || "<tr><td colspan='5'>Veri Yok</td></tr>";

        let h2=""; d.hareketler.forEach(x => {
            let clr = x.islem_tipi.includes('GIRIS') ? 'green' : (x.islem_tipi.includes('ZIMMET') ? 'orange' : 'red');
            h2+=`<tr style="color:${clr}"><td>${new Date(x.tarih).toLocaleString()}</td><td>${x.islem_tipi}</td><td>${x.bolum||'-'}</td><td>${x.urun}</td><td>${x.miktar}</td><td>${x.aciklama||''}</td></tr>`
        });
        document.querySelector('#trHar tbody').innerHTML = h2 || "<tr><td colspan='6'>Hareket Yok</td></tr>";

        let z = await(await fetch(API+'/rapor/zimmet')).json();
        let h3=""; z.forEach(x => h3+=`<tr><td>${x.ad_soyad}</td><td>${x.urun}</td><td>${x.miktar}</td></tr>`);
        document.querySelector('#trZim tbody').innerHTML = h3 || "<tr><td colspan='3'>Zimmet Yok</td></tr>";
    }

    function tab(id) {
        document.querySelectorAll('.page').forEach(x=>x.style.display='none');
        document.querySelectorAll('.tabs button').forEach(x=>x.classList.remove('active'));
        document.getElementById(id).style.display='block';
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>