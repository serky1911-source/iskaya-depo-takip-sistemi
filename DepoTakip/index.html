<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo V10.1 (Fix)</title>
    <style>
        :root { --p: #2c3e50; --s: #34495e; --a: #3498db; --d: #e74c3c; --g: #27ae60; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        #Login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--p); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .box { background: white; padding: 40px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--a); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-red { background: var(--d); } .btn-green { background: var(--g); }
        #Panel { display: none; max-width: 1100px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; }
        header { background: var(--p); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .tabs { display: flex; background: #ddd; }
        .tabs button { background: transparent; color: #555; padding: 15px; margin: 0; border-radius: 0; flex: 1; }
        .tabs button.active { background: white; color: var(--a); border-top: 3px solid var(--a); }
        .page { display: none; padding: 20px; } .active-page { display: block; }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; } th { background: var(--s); color: white; }
        .del-btn { padding: 5px 10px; font-size: 0.8rem; background: var(--d); width: auto; }
        @media(max-width: 600px) { .row { flex-direction: column; } .tabs { flex-wrap: wrap; } }
    </style>
</head>
<body>

<div id="Login">
    <div class="box">
        <h2>üîí Giri≈ü</h2>
        <input type="text" id="uName" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input type="password" id="uPass" placeholder="≈ûifre">
        <button onclick="login()">Giri≈ü Yap</button>
    </div>
</div>

<div id="Panel">
    <header><h1>üè≠ Depo V10.1</h1><button onclick="location.reload()" style="width:auto; background:var(--d);">√áƒ±kƒ±≈ü</button></header>
    <div class="tabs"><button onclick="tab('pTan')" class="active">üõ†Ô∏è Tanƒ±mlamalar</button><button onclick="tab('pIsl')">üì¶ ƒ∞≈ülemler</button><button onclick="tab('pRap')">üìä Raporlar</button><button onclick="tab('pAI')">ü§ñ Asistan</button></div>

    <div id="pTan" class="page active-page">
        <div class="row">
            <div class="col card"><h3>B√∂l√ºm</h3><input id="tBolum" placeholder="Adƒ±"><button onclick="add('bolumler', {bolum_adi: v('tBolum')})">Ekle</button><div id="listBolum"></div></div>
            <div class="col card"><h3>Personel</h3><input id="tPer" placeholder="Ad Soyad"><button onclick="add('personel', {ad_soyad: v('tPer')})">Ekle</button><div id="listPer"></div></div>
        </div>
        <div class="card"><h3>√úr√ºn Tanƒ±mla</h3>
            <div class="row"><input id="tUrun" placeholder="√úr√ºn Adƒ±"><input id="tSku" placeholder="SKU"><input id="tBirim" placeholder="Birim"></div>
            <div class="row"><select id="tTur"><option>Sarf</option><option>Demirba≈ü</option></select><input type="number" id="tGuv" placeholder="G√ºvenlik Stoƒüu"><button onclick="add('urunler', {urun_adi:v('tUrun'), sku:v('tSku'), birim:v('tBirim'), tur:v('tTur'), guvenlik_stogu:v('tGuv')})">Kaydet</button></div>
            <div style="margin-top:10px; max-height:200px; overflow-y:auto;" id="listUrun"></div>
        </div>
        <div class="card" style="border: 2px dashed green;"><h3>üì• Excel Y√ºkle</h3><input type="file" id="xlsFile"><button class="btn-green" onclick="uploadXls()">Y√ºkle</button></div>
    </div>

    <div id="pIsl" class="page">
        <div class="card"><h3>Stok Giri≈ü/√áƒ±kƒ±≈ü</h3>
            <select id="iIslem"><option value="giris">Mal Kabul</option><option value="cikis">T√ºketim</option></select>
            <div class="row"><select id="iUrun"><option>√úr√ºn...</option></select><select id="iBolum"><option>B√∂l√ºm...</option></select></div>
            <input type="number" id="iMiktar" placeholder="Miktar"><input id="iAciklama" placeholder="Belge No"><button onclick="doIslem()">Onayla</button>
        </div>
        <div class="row">
            <div class="col card"><h3>Transfer</h3><select id="trUrun"><option>√úr√ºn...</option></select><select id="trCikis"><option>Kaynak</option></select><select id="trGiris"><option>Hedef</option></select><input type="number" id="trMiktar" placeholder="Miktar"><button onclick="doTransfer()">Transfer</button></div>
            <div class="col card"><h3>Zimmet</h3><select id="zUrun"><option>√úr√ºn...</option></select><select id="zBolum"><option>Depo</option></select><select id="zPer"><option>Personel</option></select><input type="number" id="zMiktar" placeholder="Adet"><button class="btn-red" onclick="doZimmet()">Zimmetle</button></div>
        </div>
    </div>

    <div id="pRap" class="page"><button class="btn-green" onclick="loadReports()">üîÑ Yenile</button><div class="card"><h3>üì¶ Stok</h3><table id="tblStok"><thead><tr><th>B√∂l√ºm</th><th>√úr√ºn</th><th>SKU</th><th>Miktar</th></tr></thead><tbody></tbody></table></div><div class="card"><h3>üë∑ Zimmet</h3><table id="tblZimmet"><thead><tr><th>Personel</th><th>√úr√ºn</th><th>Adet</th><th>Tarih</th></tr></thead><tbody></tbody></table></div></div>

    <div id="pAI" class="page"><div class="card" style="text-align:center;"><h3>ü§ñ Asistan</h3><input id="aiQ" placeholder="Soru sor..."><button onclick="askAI()" style="background:#673ab7; margin-top:10px;">Sor</button><div id="aiRes" style="margin-top:20px; text-align:left; background:#eee; padding:15px;">...</div></div></div>
</div>

<script>
    const API = "/api"; const v = (id) => document.getElementById(id).value;
    async function login() {
        try { let res = await fetch(API+'/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({kullanici_adi:v('uName'), sifre:v('uPass')})});
        if(res.ok) { document.getElementById('Login').style.display='none'; document.getElementById('Panel').style.display='block'; init(); } else alert("Hatalƒ± Giri≈ü!"); } catch(e) { alert("Hata: "+e); }
    }
    async function init() { await loadLists(); await loadReports(); }
    async function loadLists() {
        let bol = await (await fetch(API+'/data/bolumler')).json(); let per = await (await fetch(API+'/data/personel')).json(); let uru = await (await fetch(API+'/data/urunler')).json();
        renderList('listBolum', bol, 'bolumler', 'bolum_adi'); renderList('listPer', per, 'personel', 'ad_soyad'); renderList('listUrun', uru, 'urunler', 'urun_adi', 'SKU');
        fillSel('iBolum', bol, 'bolum_id', 'bolum_adi'); fillSel('trCikis', bol, 'bolum_id', 'bolum_adi'); fillSel('trGiris', bol, 'bolum_id', 'bolum_adi'); fillSel('zBolum', bol, 'bolum_id', 'bolum_adi');
        fillSel('iUrun', uru, 'SKU', 'urun_adi'); fillSel('trUrun', uru, 'SKU', 'urun_adi'); fillSel('zUrun', uru, 'SKU', 'urun_adi'); fillSel('zPer', per, 'personel_id', 'ad_soyad');
    }
    function renderList(div, data, path, f1, f2) { document.getElementById(div).innerHTML = '<table>'+data.map(i=>`<tr><td>${i[f1]} ${f2?`(${i[f2]})`:''}</td><td style="text-align:right"><button class="del-btn" onclick="del('${path}', ${Object.values(i)[0]})">Sil</button></td></tr>`).join('')+'</table>'; }
    function fillSel(id, data, val, txt) { document.getElementById(id).innerHTML = '<option value="">Se√ß...</option>' + data.map(i=>`<option value="${i[val]}">${i[txt]}</option>`).join(''); }
    async function add(p, d) { let r = await fetch(API+'/'+p, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}); if(r.ok){alert("Eklendi"); loadLists();} }
    async function del(p, id) { if(confirm("Sil?")) { await fetch(API+'/'+p+'/'+id, {method:'DELETE'}); loadLists(); } }
    async function doIslem() { let r = await fetch(API+'/islem/'+v('iIslem'), {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({sku:v('iUrun'), bolum_id:v('iBolum'), miktar:v('iMiktar'), aciklama:v('iAciklama')})}); if(r.ok) alert("Tamam"); }
    async function doTransfer() { let r = await fetch(API+'/islem/transfer', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({sku:v('trUrun'), cikis_bolum_id:v('trCikis'), giris_bolum_id:v('trGiris'), miktar:v('trMiktar')})}); if(r.ok) alert("Tamam"); }
    async function doZimmet() { let r = await fetch(API+'/islem/zimmet', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({sku:v('zUrun'), bolum_id:v('zBolum'), personel_id:v('zPer'), miktar:v('zMiktar')})}); if(r.ok) alert("Tamam"); }
    async function uploadXls() { let fd = new FormData(); fd.append("file", document.getElementById('xlsFile').files[0]); let r = await fetch(API+'/admin/excel', {method:'POST', body:fd}); alert((await r.json()).msg); loadLists(); }
    async function loadReports() {
        let s = await (await fetch(API+'/rapor/stok')).json(); document.querySelector('#tblStok tbody').innerHTML = s.map(i=>`<tr><td>${i.bolum_adi}</td><td>${i.urun_adi}</td><td>${i.SKU}</td><td><b>${i.mevcut}</b></td></tr>`).join('') || "<tr><td colspan='4'>Yok</td></tr>";
        let z = await (await fetch(API+'/rapor/zimmet')).json(); document.querySelector('#tblZimmet tbody').innerHTML = z.map(i=>`<tr><td>${i.ad_soyad}</td><td>${i.urun_adi}</td><td>${i.miktar}</td><td>${new Date(i.tarih).toLocaleDateString()}</td></tr>`).join('') || "<tr><td colspan='4'>Yok</td></tr>";
    }
    async function askAI() { document.getElementById('aiRes').innerText="..."; let r=await fetch(API+'/ai/sor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({soru:v('aiQ')})}); document.getElementById('aiRes').innerText=(await r.json()).cevap; }
    function tab(id) { document.querySelectorAll('.page').forEach(x=>x.style.display='none'); document.querySelectorAll('.tabs button').forEach(x=>x.classList.remove('active')); document.getElementById(id).style.display='block'; event.currentTarget.classList.add('active'); }
</script>
</body>
</html>