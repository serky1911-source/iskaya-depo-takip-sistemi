<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo Takip Pro V8.0 (Fix)</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --light: #ecf0f1; --ai: #673ab7; --excel: #217346; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f3; margin: 0; padding: 10px; color: #333; }
        #LoginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-box h2 { color: var(--primary); margin-bottom: 20px; }
        #Dashboard { display: none; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 10px; margin-top: 0; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; font-size: 1.5rem; }
        h2 { color: var(--secondary); font-size: 1.1rem; margin-top: 20px; border-left: 5px solid var(--accent); padding-left: 10px; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { background-color: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #2980b9; } .btn-danger { background-color: var(--danger); } .btn-logout { background-color: var(--danger); width: auto; font-size: 0.8rem; padding: 8px 15px; }
        .badge-manager { background-color: #e1f5fe; color: #0277bd; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; border: 1px solid #81d4fa; display: none; }
        .admin-only { display: block; }
        .tab { overflow: hidden; background-color: var(--primary); border-radius: 8px 8px 0 0; display: flex; flex-wrap: wrap; }
        .tab button { background-color: inherit; border: none; outline: none; cursor: pointer; padding: 12px 15px; transition: 0.3s; color: white; flex-grow: 1; border-radius: 0; margin: 0; font-size: 0.9rem; white-space: nowrap; }
        .tab button:hover { background-color: var(--secondary); } .tab button.active { background-color: var(--accent); }
        .tabcontent { display: none; padding: 15px; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; animation: fadeEffect 0.5s; background: #fff; }
        .excel-box { border: 2px dashed var(--excel); background-color: #e8f5e9; padding: 15px; margin-top: 20px; border-radius: 8px; text-align: center; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; min-width: 600px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; } th { background-color: var(--primary); color: white; } tr:nth-child(even) { background-color: #f9f9f9; }
        .kritik-stok { background-color: #ffcccc !important; color: #a00; font-weight: bold; }
        .search-box { padding: 10px; width: 100%; border: 2px solid var(--accent); margin-bottom: 10px; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
        .flex-row { display: flex; gap: 10px; } .flex-col { flex: 1; }
        @media screen and (max-width: 768px) { .flex-row { flex-direction: column; gap: 0; } .flex-col { width: 100%; } .tab button { flex: 1 1 45%; text-align: center; font-size: 0.8rem; padding: 10px 5px; } h1 { font-size: 1.2rem; flex-direction: column; align-items: flex-start; } .btn-logout { width: 100%; margin-top: 5px; text-align: center; } }
    </style>
</head>
<body>
<div id="LoginScreen">
    <div class="login-box"><h2>ğŸ”’ GÃ¼venli GiriÅŸ</h2><input type="text" id="kullaniciAdi" placeholder="KullanÄ±cÄ± AdÄ±"><input type="password" id="sifre" placeholder="Åifre"><button onclick="girisYap()">GiriÅŸ Yap</button></div>
</div>
<div id="Dashboard">
    <div class="container">
        <h1><span>ğŸ­ Depo YÃ¶netim <span id="viewBadge" class="badge-manager">ğŸ‘ï¸ YÃ¶netici</span></span><button class="btn-logout" onclick="cikisYap()">Ã‡Ä±kÄ±ÅŸ (<span id="aktifKullanici"></span>)</button></h1>
        <div class="tab"><button class="tablinks" onclick="openTab(event, 'Tanimlamalar')" id="defaultOpen">ğŸ› ï¸ TanÄ±m</button><button class="tablinks" onclick="openTab(event, 'StokIslem')">ğŸ“¦ Ä°ÅŸlem</button><button class="tablinks" onclick="openTab(event, 'TransferZimmet')">ğŸšš Transfer</button><button class="tablinks" onclick="openTab(event, 'Raporlar')">ğŸ“Š Rapor</button><button class="tablinks" onclick="openTab(event, 'AiAsistan')" style="background-color: var(--ai);">ğŸ¤– AI</button></div>
        
        <div id="Tanimlamalar" class="tabcontent">
            <div id="mudurDashboard1" style="display:none; text-align:center; padding: 10px;"><h3>ğŸ“‹ KayÄ±tlar</h3><div class="flex-row"><button style="background:#34495e;" onclick="listeGoster('bolum')">ğŸ¢ BÃ¶lÃ¼mler</button><button style="background:#34495e;" onclick="listeGoster('personel')">ğŸ‘· Personeller</button><button style="background:#34495e;" onclick="listeGoster('urun')">ğŸ“¦ ÃœrÃ¼nler</button></div><div id="basitListe" style="margin-top:15px; text-align:left; max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:15px; border-radius:5px; background:#f9f9f9;"><i>Liste seÃ§iniz...</i></div></div>
            <div class="admin-only">
                <div class="flex-row"><div class="flex-col"><h2>BÃ¶lÃ¼m Ekle</h2><input type="text" id="yeniBolumAdi" placeholder="Ã–rn: Kaynak AtÃ¶lyesi"><button onclick="bolumEkle()">Kaydet</button></div><div class="flex-col"><h2>Personel Ekle</h2><input type="text" id="yeniPersonelAdi" placeholder="Ã–rn: Ahmet YÄ±lmaz"><button onclick="personelEkle()">Kaydet</button></div></div><hr>
                <h2>ÃœrÃ¼n TanÄ±mla</h2><div class="flex-row"><input type="text" id="yeniUrunAdi" placeholder="ÃœrÃ¼n AdÄ±"><input type="text" id="yeniSku" placeholder="SKU/Barkod"><input type="text" id="yeniBirim" placeholder="Birim" style="width: 30%;"></div><div class="flex-row"><select id="yeniTur"><option value="Sarf">Sarf Malzeme</option><option value="DemirbaÅŸ">DemirbaÅŸ</option></select><input type="number" id="yeniGuvenlik" placeholder="GÃ¼venlik StoÄŸu"><button onclick="urunEkle()">ÃœrÃ¼nÃ¼ Ä°ÅŸle</button></div>
                <div class="excel-box"><h3>ğŸ“¥ Toplu Excel YÃ¼kle</h3><p style="font-size: 0.9rem;">SÃ¼tunlar: <b>ÃœrÃ¼n AdÄ±, SKU, BÃ¶lÃ¼m, Miktar, Birim, TÃ¼r, GÃ¼venlik StoÄŸu</b></p><input type="file" id="excelDosyasi" accept=".xlsx, .xls" style="background: white;"><button onclick="excelYukle()" style="background-color: var(--excel); width: 50%;">YÃ¼klemeyi BaÅŸlat</button><p id="excelDurum" style="font-weight: bold; color: var(--excel);"></p></div>
            </div>
        </div>

        <div id="StokIslem" class="tabcontent">
            <div class="admin-only"><h2>Mal Kabul / TÃ¼ketim</h2><label>Ä°ÅŸlem TÃ¼rÃ¼:</label><select id="islemTuru"><option value="giris">Mal Kabul (GiriÅŸ)</option><option value="cikis">TÃ¼ketim (Ã‡Ä±kÄ±ÅŸ)</option></select><div class="flex-row"><select id="islemBolumId" class="flex-col"><option>BÃ¶lÃ¼m SeÃ§iniz...</option></select><select id="islemUrunSku" class="flex-col"><option>ÃœrÃ¼n SeÃ§iniz...</option></select></div><input type="number" id="islemMiktar" placeholder="Miktar"><input type="text" id="islemBelge" placeholder="Belge No / AÃ§Ä±klama"><button onclick="stokIslemYap()">Onayla</button></div>
            <div id="mudurDashboard2" style="display:none; text-align:center; padding:20px;"><h2 style="color:#7f8c8d;">ğŸ“¦ Stok OperasyonlarÄ±</h2><p>Yetkili giriÅŸi gereklidir.</p><button onclick="openTab({currentTarget: document.querySelector('.tab button:nth-child(4)')}, 'Raporlar')" style="width:100%; margin-top:10px;">ğŸ“Š Raporlara Git</button></div>
        </div>

        <div id="TransferZimmet" class="tabcontent">
            <div class="admin-only"><div class="flex-row"><div class="flex-col" style="border-right: 1px solid #ddd; padding-right: 15px; border-bottom: 1px solid #ddd; padding-bottom: 15px;"><h2 style="color: var(--accent);">ğŸ”„ Transfer</h2><select id="trUrun"><option>ÃœrÃ¼n SeÃ§...</option></select><label>Nereden?</label><select id="trCikisBolum"><option>Kaynak...</option></select><label>Nereye?</label><select id="trGirisBolum"><option>Hedef...</option></select><input type="number" id="trMiktar" placeholder="Miktar"><button onclick="transferYap()">Transfer Et</button></div><div class="flex-col" style="padding-left: 15px;"><h2 style="color: var(--danger);">ğŸ‘· Zimmet</h2><select id="zimUrun"><option>ÃœrÃ¼n SeÃ§...</option></select><select id="zimBolum"><option>Depo SeÃ§...</option></select><select id="zimPersonel"><option>Personel...</option></select><input type="number" id="zimMiktar" value="1" placeholder="Adet"><button class="btn-danger" onclick="zimmetVer()">Zimmetle</button></div></div></div>
             <div id="mudurDashboard3" style="display:none; text-align:center; padding:20px;"><h2 style="color:#7f8c8d;">Operasyonlar</h2><p>Yetkili personelce yapÄ±lÄ±r.</p><button onclick="zimmetRaporuGetir(); openTab({currentTarget: document.querySelector('.tab button:nth-child(4)')}, 'Raporlar')" style="width:100%; margin-top:10px; background-color:var(--secondary);">ğŸ‘· Zimmet Listesi</button></div>
        </div>

        <div id="Raporlar" class="tabcontent">
            <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3>ğŸ” DetaylÄ± Sorgulama</h3><div class="flex-row"><div class="flex-col"><label>BaÅŸlangÄ±Ã§:</label><input type="date" id="rapBaslangic"></div><div class="flex-col"><label>BitiÅŸ:</label><input type="date" id="rapBitis"></div><div class="flex-col"><label>Depo:</label><select id="rapBolum"><option value="0">TÃ¼m Depolar</option></select></div><div class="flex-col" style="display: flex; align-items: flex-end;"><button onclick="hareketRaporuGetir()" style="background-color: var(--primary);">ğŸ“œ Listele</button></div></div>
            </div>
            <div class="flex-row"><button onclick="stokRaporuGetir()">ğŸ“¦ AnlÄ±k Stok</button><button onclick="zimmetRaporuGetir()" style="background-color: var(--secondary);">ğŸ‘· Zimmetler</button></div><input type="text" id="tabloArama" class="search-box" onkeyup="tabloFiltrele()" placeholder="Tabloda ara..."><div class="table-responsive"><table id="raporTablosu"><thead></thead><tbody></tbody></table></div>
        </div>

        <div id="AiAsistan" class="tabcontent">
            <div style="text-align: center; padding: 10px;"><h2 style="color: var(--ai);">ğŸ¤– AI Asistan</h2><p>Depo hakkÄ±nda merak ettiklerini sor.</p><div style="max-width: 600px; margin: 0 auto;"><input type="text" id="aiSoru" placeholder="Soru sor..." style="padding: 15px; border: 2px solid var(--ai); width: 100%; border-radius: 5px;"><br><br><button onclick="aiSor()" style="background-color: var(--ai); padding: 15px; width: 100%;">ğŸš€ GÃ¶nder</button></div><div id="aiCevapKutusu" style="display:none; margin-top: 20px; padding: 15px; background: #f3e5f5; border-radius: 8px; border-left: 5px solid var(--ai); text-align: left;"><b style="color: var(--ai);">Gemini:</b><p id="aiCevapText" style="margin-top: 10px; white-space: pre-wrap;">...</p></div></div>
        </div>
    </div>
</div>

<script>
    const API_URL = "";
    async function girisYap() { const k=document.getElementById('kullaniciAdi').value;const s=document.getElementById('sifre').value;try{const r=await fetch(`${API_URL}/giris`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({kullanici_adi:k,sifre:s})});if(r.ok){const d=await r.json();document.getElementById('LoginScreen').style.display='none';document.getElementById('Dashboard').style.display='block';document.getElementById('aktifKullanici').innerText=d.ad;if(d.rol==='izleyici'){document.getElementById('viewBadge').style.display='inline-block';document.querySelectorAll('.admin-only').forEach(e=>e.style.display='none');document.getElementById('mudurDashboard1').style.display='block';document.getElementById('mudurDashboard2').style.display='block';document.getElementById('mudurDashboard3').style.display='block';openTab({currentTarget:document.querySelector('.tab button:nth-child(4)')},'Raporlar')}else{document.getElementById("defaultOpen").click()}sayfaYukle()}else{alert("HatalÄ± GiriÅŸ!")}}catch(e){alert("BaÄŸlantÄ± hatasÄ±!")}}
    function cikisYap() { location.reload(); }
    async function listeGoster(t) { let u='';if(t==='bolum')u='/bolumler/listele';if(t==='personel')u='/personel/listele';if(t==='urun')u='/urunler/listele';const d=await getData(u);let h="<ul style='list-style-type:circle; padding-left:20px;'>";d.forEach(i=>{if(t==='bolum')h+=`<li><b>${i.bolum_adi}</b></li>`;if(t==='personel')h+=`<li>${i.ad_soyad}</li>`;if(t==='urun')h+=`<li>${i.urun_adi} <span style='color:#777;'>(${i.SKU})</span></li>`});h+="</ul>";document.getElementById('basitListe').innerHTML=h}
    async function aiSor() { const s=document.getElementById('aiSoru').value;if(!s)return alert("Soru yazÄ±n!");const k=document.getElementById('aiCevapKutusu');const t=document.getElementById('aiCevapText');k.style.display='block';t.innerText="ğŸ¤” DÃ¼ÅŸÃ¼nÃ¼yorum...";try{const r=await fetch(`${API_URL}/ai/sor`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({soru:s})});const d=await r.json();t.innerText=d.cevap}catch(e){t.innerText="Hata: "+e}}
    async function excelYukle() { const f=document.getElementById('excelDosyasi');const t=document.getElementById('excelDurum');if(f.files.length===0)return alert("Dosya seÃ§in!");const fd=new FormData();fd.append("file",f.files[0]);t.innerText="â³ YÃ¼kleniyor...";try{const r=await fetch(`${API_URL}/admin/excel-yukle`,{method:'POST',body:fd});const d=await r.json();if(r.ok){alert(d.mesaj);t.innerText="âœ… "+d.mesaj;sayfaYukle()}else{alert("HATA: "+d.detail);t.innerText="âŒ Hata"}}catch(e){alert("Hata: "+e);t.innerText="âŒ Hata"}}
    
    async function postData(u,d) { const r=await fetch(`${API_URL}${u}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});if(r.ok){alert("BaÅŸarÄ±lÄ±! âœ…");sayfaYukle()}else{const e=await r.json();alert("HATA: "+e.detail)}}
    async function getData(u) { const r=await fetch(`${API_URL}${u}`);return await r.json()}
    function bolumEkle(){ postData('/bolumler/ekle',{bolum_adi:document.getElementById('yeniBolumAdi').value}) }
    function personelEkle(){ postData('/personel/ekle',{ad_soyad:document.getElementById('yeniPersonelAdi').value}) }
    function urunEkle(){ postData('/urunler/ekle',{urun_adi:document.getElementById('yeniUrunAdi').value,sku:document.getElementById('yeniSku').value,birim:document.getElementById('yeniBirim').value,tur:document.getElementById('yeniTur').value,guvenlik_stogu:parseInt(document.getElementById('yeniGuvenlik').value)}) }
    function stokIslemYap(){ const t=document.getElementById('islemTuru').value;postData(`/stok/${t}`,{sku:document.getElementById('islemUrunSku').value,bolum_id:parseInt(document.getElementById('islemBolumId').value),miktar:parseFloat(document.getElementById('islemMiktar').value),belge_no:document.getElementById('islemBelge').value}) }
    function transferYap(){ postData('/stok/transfer',{sku:document.getElementById('trUrun').value,cikis_bolum_id:parseInt(document.getElementById('trCikisBolum').value),giris_bolum_id:parseInt(document.getElementById('trGirisBolum').value),miktar:parseFloat(document.getElementById('trMiktar').value)}) }
    function zimmetVer(){ postData('/zimmet/ver',{sku:document.getElementById('zimUrun').value,personel_id:parseInt(document.getElementById('zimPersonel').value),bolum_id:parseInt(document.getElementById('zimBolum').value),miktar:parseFloat(document.getElementById('zimMiktar').value)}) }
    
    async function hareketRaporuGetir() {
        const v={baslangic_tarihi:document.getElementById('rapBaslangic').value,bitis_tarihi:document.getElementById('rapBitis').value,bolum_id:parseInt(document.getElementById('rapBolum').value)};
        const d=await(await fetch(`${API_URL}/rapor/hareketler`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(v)})).json();
        const b=document.querySelector('#raporTablosu tbody');document.querySelector('#raporTablosu thead').innerHTML=`<tr><th>Tarih</th><th>Ä°ÅŸlem</th><th>Depo</th><th>ÃœrÃ¼n</th><th>Miktar</th><th>AÃ§Ä±klama</th></tr>`;b.innerHTML="";
        if(d.length===0){b.innerHTML="<tr><td colspan='6' style='text-align:center'>KayÄ±t yok.</td></tr>";return}
        d.forEach(r=>{const c=r.islem_tipi==='GÄ°RÄ°Å'?'#eafaf1':'#fdedec';b.innerHTML+=`<tr style="background-color:${c}"><td>${new Date(r.tarih).toLocaleString('tr-TR')}</td><td>${r.islem_tipi}</td><td>${r.bolum_adi}</td><td>${r.urun_adi}</td><td>${r.miktar}</td><td>${r.aciklama}</td></tr>`})
    }
    async function stokRaporuGetir() {
        const d=await getData('/rapor/genel-stok');const b=document.querySelector('#raporTablosu tbody');document.querySelector('#raporTablosu thead').innerHTML=`<tr><th>BÃ¶lÃ¼m</th><th>ÃœrÃ¼n</th><th>SKU</th><th>Tip</th><th>Stok</th><th>UyarÄ±</th></tr>`;b.innerHTML="";
        if(d.length===0){b.innerHTML="<tr><td colspan='6' style='text-align:center'>Depoda Ã¼rÃ¼n gÃ¶rÃ¼nmÃ¼yor.</td></tr>";return}
        d.forEach(r=>{const c=r.uyari?'kritik-stok':'';b.innerHTML+=`<tr class="${c}"><td>${r.bolum_adi}</td><td>${r.urun_adi}</td><td>${r.SKU}</td><td>${r.tur}</td><td>${r.mevcut_stok}</td><td>${r.uyari?'ğŸš¨ KRÄ°TÄ°K':'âœ…'}</td></tr>`})
    }
    async function zimmetRaporuGetir() {
        const d=await getData('/rapor/zimmetler');const b=document.querySelector('#raporTablosu tbody');document.querySelector('#raporTablosu thead').innerHTML=`<tr><th>Tarih</th><th>Personel</th><th>ÃœrÃ¼n</th><th>SKU</th><th>Adet</th></tr>`;b.innerHTML="";
        if(d.length===0){b.innerHTML="<tr><td colspan='5' style='text-align:center'>Zimmetli Ã¼rÃ¼n yok.</td></tr>";return}
        d.forEach(r=>{b.innerHTML+=`<tr><td>${new Date(r.verilis_tarihi).toLocaleString('tr-TR')}</td><td>${r.ad_soyad}</td><td>${r.urun_adi}</td><td>${r.SKU}</td><td>${r.miktar}</td></tr>`})
    }
    function tabloFiltrele() { var f=document.getElementById("tabloArama").value.toUpperCase();var t=document.getElementById("raporTablosu").getElementsByTagName("tr");for(var i=0;i<t.length;i++){if(t[i].innerText.toUpperCase().indexOf(f)>-1)t[i].style.display="";else if(i!==0)t[i].style.display="none"}}
    
    async function sayfaYukle() {
        // TARÄ°H AYARI: Otomatik olarak SON 30 GÃœNÃœ seÃ§
        const bugun = new Date();
        const gecmis = new Date(); gecmis.setDate(bugun.getDate() - 30);
        document.getElementById('rapBaslangic').value = gecmis.toISOString().split('T')[0];
        document.getElementById('rapBitis').value = bugun.toISOString().split('T')[0];

        const b=await getData('/bolumler/listele');const u=await getData('/urunler/listele');const p=await getData('/personel/listele');
        const s=(i,d,v,t,x)=>{const e=document.getElementById(i);if(!e)return;e.innerHTML=`<option value="">${x}</option>`;d.forEach(o=>e.innerHTML+=`<option value="${o[v]}">${o[t]}</option>`)};
        s('islemBolumId',b,'bolum_id','bolum_adi','BÃ¶lÃ¼m SeÃ§...');s('trCikisBolum',b,'bolum_id','bolum_adi','BÃ¶lÃ¼m SeÃ§...');s('trGirisBolum',b,'bolum_id','bolum_adi','BÃ¶lÃ¼m SeÃ§...');s('zimBolum',b,'bolum_id','bolum_adi','BÃ¶lÃ¼m SeÃ§...');
        s('islemUrunSku',u,'SKU','urun_adi','ÃœrÃ¼n SeÃ§...');s('trUrun',u,'SKU','urun_adi','ÃœrÃ¼n SeÃ§...');s('zimUrun',u,'SKU','urun_adi','ÃœrÃ¼n SeÃ§...');
        s('zimPersonel',p,'personel_id','ad_soyad','Personel SeÃ§...');
        const rb=document.getElementById('rapBolum');rb.innerHTML='<option value="0">TÃ¼m Depolar</option>';b.forEach(o=>rb.innerHTML+=`<option value="${o.bolum_id}">${o.bolum_adi}</option>`)
    }
    function openTab(e,n){var i,c,l;c=document.getElementsByClassName("tabcontent");for(i=0;i<c.length;i++)c[i].style.display="none";l=document.getElementsByClassName("tablinks");for(i=0;i<l.length;i++)l[i].className=l[i].className.replace(" active","");document.getElementById(n).style.display="block";if(e.currentTarget)e.currentTarget.className+=" active"}
</script>
</body>
</html>