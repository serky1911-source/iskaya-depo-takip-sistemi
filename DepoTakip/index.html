<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo V17 - Kusursuz Takip</title>
    <style>
        :root {
            --primary: #2c3e50; /* Koyu Lacivert */
            --accent: #3498db;  /* Mavi */
            --success: #27ae60; /* Ye≈üil */
            --danger: #c0392b;  /* Kƒ±rmƒ±zƒ± */
            --light: #ecf0f1;   /* A√ßƒ±k Gri */
            --dark: #2c3e50;
        }
        body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--light); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        #sidebar { width: 250px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        #sidebar h2 { margin-top: 0; font-size: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .menu-item { padding: 12px 15px; cursor: pointer; border-radius: 6px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .menu-item.active { background: var(--accent); font-weight: bold; }
        
        /* MAIN CONTENT */
        #main { flex: 1; padding: 30px; overflow-y: auto; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & FORMS */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--light); padding-bottom: 10px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        input, select, button { padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { filter: brightness(1.1); }
        button.btn-green { background: var(--success); }
        button.btn-red { background: var(--danger); }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: var(--primary); color: white; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; color: white; }
        .bg-sarf { background: #e67e22; }
        .bg-demirbas { background: #8e44ad; }

        /* TOAST */
        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--dark); color: white; padding: 15px 25px; border-radius: 5px; display: none; z-index: 1000; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>üè≠ Depo V17</h2>
        <div class="menu-item active" onclick="showPage('dashboard')">üè† Genel Durum</div>
        <div class="menu-item" onclick="showPage('tanimlar')">üõ†Ô∏è Tanƒ±mlamalar</div>
        <div class="menu-item" onclick="showPage('stok')">üì¶ Stok ƒ∞≈ülemleri</div>
        <div class="menu-item" onclick="showPage('demirbas')">üíª Demirba≈ü & Zimmet</div>
        <div class="menu-item" onclick="showPage('rapor')">üìä Raporlama</div>
    </div>

    <div id="main">
        
        <div id="dashboard" class="page active">
            <h3>Ho≈ü Geldiniz</h3>
            <div class="form-grid">
                <div class="card" style="text-align:center;">
                    <h1>üì¶</h1>
                    <p>Kusursuz Stok Takibi</p>
                </div>
                <div class="card" style="text-align:center;">
                    <h1>üíª</h1>
                    <p>Demirba≈ü Zimmet Y√∂netimi</p>
                </div>
                <div class="card" style="text-align:center;">
                    <h1>üìä</h1>
                    <p>Detaylƒ± Raporlama</p>
                </div>
            </div>
        </div>

        <div id="tanimlar" class="page">
            <div class="card">
                <h3>‚ûï Depo & B√∂l√ºm Ekle</h3>
                <div class="form-grid">
                    <div><input id="t_depo_ad" placeholder="Yeni Depo Adƒ± (√ñrn: Merkez Depo)"><button onclick="ekle('depo')" style="margin-top:5px">Depo Kaydet</button></div>
                    <div><input id="t_bolum_ad" placeholder="Yeni B√∂l√ºm Adƒ± (√ñrn: Kaynak At√∂lyesi)"><button onclick="ekle('bolum')" style="margin-top:5px">B√∂l√ºm Kaydet</button></div>
                    <div><input id="t_per_ad" placeholder="Personel Ad Soyad"><button onclick="ekle('personel')" style="margin-top:5px">Personel Kaydet</button></div>
                </div>
            </div>

            <div class="card">
                <h3>üì¶ √úr√ºn Tanƒ±mla</h3>
                <div class="form-grid">
                    <input id="u_ad" placeholder="√úr√ºn Adƒ±">
                    <input id="u_sku" placeholder="SKU / Kod">
                    <select id="u_tip">
                        <option value="SARF">SARF MALZEME</option>
                        <option value="DEMIRBAS">DEMƒ∞RBA≈û</option>
                    </select>
                    <input id="u_birim" placeholder="Birim (Adet, Kg)">
                    <input id="u_guv" type="number" placeholder="G√ºvenlik Stoƒüu">
                    <button onclick="urunEkle()" class="btn-green">√úr√ºn√º Kaydet</button>
                </div>
            </div>
        </div>

        <div id="stok" class="page">
            <div class="card" style="border-left: 5px solid var(--success);">
                <h3>üì• Mal Kabul (Giri≈ü)</h3>
                <div class="form-grid">
                    <select id="g_urun"><option>√úr√ºn Se√ß...</option></select>
                    <select id="g_depo"><option>Hangi Depoya?</option></select>
                    <input id="g_miktar" type="number" placeholder="Miktar">
                    <input id="g_aciklama" placeholder="A√ßƒ±klama / Belge No">
                    <button onclick="stokIslem('giris')" class="btn-green">Giri≈ü Yap</button>
                </div>
                <small style="color:gray;">* Demirba≈ü giri≈üi yaparsanƒ±z miktar kadar tekil kayƒ±t olu≈üturulur.</small>
            </div>

            <div class="card" style="border-left: 5px solid #e67e22;">
                <h3>üöö Transfer & T√ºketim (Sarf)</h3>
                <div class="form-grid">
                    <select id="tr_tip" onchange="toggleTransferUI()">
                        <option value="transfer">Depolar Arasƒ± Transfer</option>
                        <option value="cikis">T√ºketim √áƒ±kƒ±≈üƒ± (Sarf)</option>
                    </select>
                    <select id="tr_urun"><option>Sarf Malzeme Se√ß...</option></select>
                    <select id="tr_kaynak"><option>Kaynak Depo</option></select>
                    
                    <select id="tr_hedef_depo"><option>Hedef Depo</option></select>
                    <select id="tr_hedef_bolum" style="display:none"><option>Hangi B√∂l√ºme?</option></select>
                    
                    <input id="tr_miktar" type="number" placeholder="Miktar">
                    <button onclick="transferYap()" style="background:#e67e22">ƒ∞≈ülemi Tamamla</button>
                </div>
            </div>
        </div>

        <div id="demirbas" class="page">
            <div class="card" style="border-left: 5px solid #8e44ad;">
                <h3>üíª Zimmet Ver</h3>
                <p>Sadece "DEPODA" stat√ºs√ºndeki demirba≈ülar listelenir.</p>
                <div class="form-grid">
                    <select id="z_demirbas"><option>Demirba≈ü Se√ß...</option></select>
                    <select id="z_hedef_tip" onchange="toggleZimmetUI()">
                        <option value="personel">Personel'e Zimmetle</option>
                        <option value="bolum">B√∂l√ºm'e Zimmetle</option>
                    </select>
                    <select id="z_personel"><option>Personel Se√ß...</option></select>
                    <select id="z_bolum" style="display:none"><option>B√∂l√ºm Se√ß...</option></select>
                    <button onclick="zimmetVer()" style="background:#8e44ad">Zimmetle</button>
                </div>
            </div>

            <div class="card" style="border-left: 5px solid var(--danger);">
                <h3>‚Ü©Ô∏è Zimmet ƒ∞ade Al</h3>
                <div class="form-grid">
                    <input id="zi_id" type="number" placeholder="Demirba≈ü ID veya Barkod Okut">
                    <select id="zi_depo"><option>Hangi Depoya D√∂necek?</option></select>
                    <select id="zi_durum">
                        <option value="DEPODA">Saƒülam (Depoya Al)</option>
                        <option value="ARIZALI">Arƒ±zalƒ±</option>
                        <option value="HURDA">Hurda</option>
                    </select>
                    <button onclick="iadeAl()" class="btn-red">ƒ∞ade Al</button>
                </div>
            </div>
        </div>

        <div id="rapor" class="page">
            <div class="card">
                <h3>üîé Hareket Ge√ßmi≈üi & Arama</h3>
                <div class="form-grid">
                    <input type="date" id="r_t1">
                    <input type="date" id="r_t2">
                    <input id="r_urun_ad" placeholder="√úr√ºn Adƒ± Ara...">
                    <button onclick="raporGetir()">Sorgula</button>
                </div>
                <table>
                    <thead><tr><th>Tarih</th><th>ƒ∞≈ülem</th><th>√úr√ºn</th><th>Miktar</th><th>Kaynak</th><th>Hedef</th><th>A√ßƒ±klama</th></tr></thead>
                    <tbody id="tbl_hareket"></tbody>
                </table>
            </div>

            <div class="card">
                <h3>üì¶ G√ºncel Stok Durumu</h3>
                <button onclick="stokGetir()">Stoklarƒ± Listele</button>
                <table>
                    <thead><tr><th>Depo</th><th>√úr√ºn</th><th>Miktar</th><th>Durum</th></tr></thead>
                    <tbody id="tbl_stok"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="toast">ƒ∞≈ülem Ba≈üarƒ±lƒ±</div>

    <script>
        // API ADRESƒ∞ (Render'da aynƒ± domain olduƒüu i√ßin g√∂receli yol kullanƒ±yoruz)
        const API_URL = ""; 

        // Sayfa Y√ºklenince
        document.addEventListener("DOMContentLoaded", () => {
            initData();
        });

        // Sayfa Ge√ßi≈üleri
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // Dropdown Doldurma Yardƒ±mcƒ±sƒ±
        async function loadSelect(url, domId, textKey='ad') {
            try {
                let res = await fetch(API_URL + url);
                let data = await res.json();
                let el = document.getElementById(domId);
                el.innerHTML = '<option value="">Se√ßiniz...</option>';
                data.forEach(item => {
                    let txt = item[textKey];
                    if(textKey === 'ozel_kod') txt = `${item.ozel_kod} - ${item.seri_no || ''}`; // Demirba≈ü i√ßin √∂zel
                    if(textKey === 'ad_soyad') txt = item.ad_soyad; // Personel i√ßin
                    el.innerHTML += `<option value="${item.id}">${txt}</option>`;
                });
            } catch(e) { console.error("Veri y√ºkleme hatasƒ±:", e); }
        }

        // Ba≈ülangƒ±√ß Verilerini √áek
        function initData() {
            // Depolar
            loadSelect('/tanim/depo', 'g_depo');
            loadSelect('/tanim/depo', 'tr_kaynak');
            loadSelect('/tanim/depo', 'tr_hedef_depo');
            loadSelect('/tanim/depo', 'zi_depo');
            
            // B√∂l√ºmler
            loadSelect('/tanim/bolum', 'tr_hedef_bolum');
            loadSelect('/tanim/bolum', 'z_bolum');
            
            // Personel
            loadSelect('/tanim/personel', 'z_personel');
            
            // √úr√ºnler
            loadSelect('/tanim/urun', 'g_urun');
            loadSelect('/tanim/urun?tip=SARF', 'tr_urun'); // Sadece Sarf
            
            // Demirba≈ü Listesi (Sadece Depoda olanlar zimmetlenebilir)
            // Not: Backend'de bu filtreyi eklemi≈ütik: demirbas_listele(durum='DEPODA')
            loadDemirbasSelect();
        }
        
        async function loadDemirbasSelect() {
            let res = await fetch('/demirbas/list?durum=DEPODA');
            let data = await res.json();
            let el = document.getElementById('z_demirbas');
            el.innerHTML = '<option>Se√ßiniz...</option>';
            data.forEach(d => {
                el.innerHTML += `<option value="${d.id}">${d.ozel_kod} (ID:${d.id})</option>`;
            });
        }

        // --- ƒ∞≈ûLEM FONKSƒ∞YONLARI ---

        // 1. Tanƒ±mlama Ekleme (Generic)
        async function ekle(tur) {
            let veri = {};
            if(tur==='depo') veri = {ad: val('t_depo_ad')};
            if(tur==='bolum') veri = {ad: val('t_bolum_ad')};
            if(tur==='personel') veri = {ad_soyad: val('t_per_ad')};
            
            await postData(`/tanim/${tur}`, veri);
            initData(); // Listeleri g√ºncelle
        }

        // 2. √úr√ºn Ekleme
        async function urunEkle() {
            let veri = {
                ad: val('u_ad'),
                sku: val('u_sku'),
                tip: val('u_tip'),
                birim: val('u_birim'),
                guvenlik_stogu: val('u_guv') || 0
            };
            await postData('/tanim/urun', veri);
            initData();
        }

        // 3. Stok Giri≈üi
        async function stokIslem(tip) {
            let veri = {
                urun_id: val('g_urun'),
                depo_id: val('g_depo'),
                miktar: val('g_miktar'),
                aciklama: val('g_aciklama')
            };
            await postData('/islem/giris', veri);
        }

        // 4. Transfer / √áƒ±kƒ±≈ü
        async function transferYap() {
            let tip = val('tr_tip');
            let url = tip === 'transfer' ? '/islem/transfer' : '/islem/cikis';
            let veri = {
                urun_id: val('tr_urun'),
                cikis_depo_id: val('tr_kaynak'), // √áƒ±kƒ±≈ü i√ßin 'depo_id' olarak map edilecek backend'de dikkat
                miktar: val('tr_miktar'),
                aciklama: "Web ƒ∞≈ülem"
            };
            
            if(tip === 'transfer') {
                veri.giris_depo_id = val('tr_hedef_depo');
            } else {
                veri.depo_id = val('tr_kaynak'); // Endpoint modeline g√∂re isim deƒüi≈üimi
                veri.bolum_id = val('tr_hedef_bolum');
            }
            
            await postData(url, veri);
        }

        // 5. Zimmet Ver
        async function zimmetVer() {
            let hedefTip = val('z_hedef_tip');
            let veri = {
                demirbas_id: val('z_demirbas'),
                aciklama: "Zimmet Atama"
            };
            
            if(hedefTip === 'personel') veri.personel_id = val('z_personel');
            else veri.bolum_id = val('z_bolum');
            
            await postData('/demirbas/zimmetle', veri);
            loadDemirbasSelect(); // Listeyi yenile
        }

        // 6. ƒ∞ade Al
        async function iadeAl() {
            let veri = {
                demirbas_id: val('zi_id'),
                hedef_depo_id: val('zi_depo'),
                durum: val('zi_durum'),
                aciklama: "ƒ∞ade"
            };
            await postData('/demirbas/iade', veri);
            loadDemirbasSelect();
        }

        // 7. Raporlama
        async function raporGetir() {
            let veri = {
                baslangic_tarihi: val('r_t1') ? val('r_t1') : null,
                bitis_tarihi: val('r_t2') ? val('r_t2') : null,
                urun_adi: val('r_urun_ad') || null
            };
            
            let res = await fetch('/rapor/gecmis', {
                method: 'POST', 
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(veri)
            });
            let data = await res.json();
            
            let html = "";
            data.forEach(r => {
                html += `<tr>
                    <td>${new Date(r.tarih).toLocaleString()}</td>
                    <td>${r.islem}</td>
                    <td>${r.urun}</td>
                    <td>${r.miktar}</td>
                    <td>${r.kaynak}</td>
                    <td>${r.hedef}</td>
                    <td>${r.aciklama}</td>
                </tr>`;
            });
            document.getElementById('tbl_hareket').innerHTML = html || "<tr><td colspan='7'>Kayƒ±t bulunamadƒ±</td></tr>";
        }

        async function stokGetir() {
            let res = await fetch('/rapor/stok-durumu', {method:'POST', headers:{'Content-Type':'application/json'}, body:'{}'});
            let data = await res.json();
            let html = "";
            data.forEach(s => {
                let color = s.durum_analizi === 'KRƒ∞Tƒ∞K' ? 'red' : 'green';
                html += `<tr>
                    <td>${s.depo}</td>
                    <td>${s.urun} (${s.sku})</td>
                    <td>${s.miktar} ${s.birim}</td>
                    <td style="color:${color}; font-weight:bold">${s.durum_analizi}</td>
                </tr>`;
            });
            document.getElementById('tbl_stok').innerHTML = html;
        }

        // YARDIMCI METODLAR
        function val(id) { return document.getElementById(id).value; }

        async function postData(url, data) {
            try {
                let res = await fetch(API_URL + url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                let json = await res.json();
                if(res.ok) {
                    showToast(json.mesaj || "ƒ∞≈ülem Ba≈üarƒ±lƒ±");
                } else {
                    alert("HATA: " + (json.detail || "Bir sorun olu≈ütu"));
                }
            } catch(e) { alert("Sunucu Hatasƒ±"); }
        }

        function showToast(msg) {
            let t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display='none', 3000);
        }

        // UI Toggle
        function toggleTransferUI() {
            let tip = val('tr_tip');
            if(tip === 'transfer') {
                document.getElementById('tr_hedef_depo').style.display = 'block';
                document.getElementById('tr_hedef_bolum').style.display = 'none';
            } else {
                document.getElementById('tr_hedef_depo').style.display = 'none';
                document.getElementById('tr_hedef_bolum').style.display = 'block';
            }
        }
        function toggleZimmetUI() {
            let tip = val('z_hedef_tip');
            if(tip === 'personel') {
                document.getElementById('z_personel').style.display = 'block';
                document.getElementById('z_bolum').style.display = 'none';
            } else {
                document.getElementById('z_personel').style.display = 'none';
                document.getElementById('z_bolum').style.display = 'block';
            }
        }
    </script>
</body>
</html>