<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Depo V12</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>body{background:#f4f6f8}.card{box-shadow:0 2px 10px rgba(0,0,0,0.1);margin-bottom:20px}</style>
</head>
<body>

<div id="loginPage" class="container mt-5" style="max-width:400px">
    <div class="card p-4 text-center">
        <h3>ğŸ”’ Depo GiriÅŸ</h3>
        <input id="uName" class="form-control mb-2" placeholder="admin">
        <input id="uPass" type="password" class="form-control mb-2" placeholder="sky1911">
        <button onclick="login()" class="btn btn-primary w-100">GiriÅŸ Yap</button>
        <p id="lMsg" class="text-danger mt-2"></p>
    </div>
</div>

<div id="mainPage" class="container-fluid p-4" style="display:none">
    <div class="d-flex justify-content-between mb-3">
        <h3>ğŸ­ Depo YÃ¶netim</h3>
        <button onclick="location.reload()" class="btn btn-danger btn-sm">Ã‡Ä±kÄ±ÅŸ</button>
    </div>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#p1">ğŸ› ï¸ TanÄ±m</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p2">ğŸ“¦ Ä°ÅŸlem</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p3" onclick="loadRep()">ğŸ“Š Rapor</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#p4">ğŸ¤– AI</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="p1">
            <div class="row">
                <div class="col-md-4"><div class="card p-3"><h5>BÃ¶lÃ¼m</h5><input id="tBol" class="form-control mb-2" placeholder="Ad"><button onclick="add('bolum',{ad:v('tBol')})" class="btn btn-success w-100">Ekle</button></div></div>
                <div class="col-md-4"><div class="card p-3"><h5>Personel</h5><input id="tPer" class="form-control mb-2" placeholder="Ad Soyad"><button onclick="add('personel',{ad_soyad:v('tPer')})" class="btn btn-success w-100">Ekle</button></div></div>
                <div class="col-md-4"><div class="card p-3"><h5>ÃœrÃ¼n</h5><input id="uAd" class="form-control mb-1" placeholder="Ad"><input id="uSku" class="form-control mb-1" placeholder="SKU"><input id="uBir" class="form-control mb-1" placeholder="Birim"><select id="uTur" class="form-select mb-1"><option>Sarf</option><option>DemirbaÅŸ</option></select><input id="uGuv" type="number" class="form-control mb-1" placeholder="GÃ¼venlik"><button onclick="add('urun',{ad:v('uAd'),sku:v('uSku'),birim:v('uBir'),tur:v('uTur'),guvenlik:v('uGuv')})" class="btn btn-primary w-100">Kaydet</button></div></div>
            </div>
            <div class="card p-3 border-success"><h5>ğŸ“¥ Excel YÃ¼kle</h5><input type="file" id="xls"><button onclick="xls()" class="btn btn-success mt-2">YÃ¼kle</button></div>
        </div>

        <div class="tab-pane fade" id="p2">
            <div class="row">
                <div class="col-md-6"><div class="card p-3">
                    <h5 class="text-primary">GiriÅŸ / Ã‡Ä±kÄ±ÅŸ</h5>
                    <select id="iTip" class="form-select mb-2"><option value="GIRIS">GiriÅŸ</option><option value="CIKIS">Ã‡Ä±kÄ±ÅŸ</option></select>
                    <div class="d-flex gap-2"><select id="iUrun" class="form-select"></select><select id="iBol" class="form-select"></select></div>
                    <input id="iMik" type="number" class="form-control my-2" placeholder="Miktar">
                    <button onclick="hareket()" class="btn btn-primary w-100">Onayla</button>
                </div></div>
                <div class="col-md-6"><div class="card p-3">
                    <h5 class="text-danger">Zimmet (DemirbaÅŸ)</h5>
                    <div class="d-flex gap-2 mb-2"><select id="zUrun" class="form-select"></select><select id="zPer" class="form-select"></select></div>
                    <select id="zBol" class="form-select mb-2"><option>Hangi Depodan?</option></select>
                    <input id="zMik" type="number" class="form-control mb-2" value="1">
                    <button onclick="zimmet()" class="btn btn-danger w-100">Zimmetle</button>
                </div></div>
            </div>
        </div>

        <div class="tab-pane fade" id="p3">
            <button onclick="loadRep()" class="btn btn-secondary mb-3">Yenile</button>
            <div class="card p-3"><h5>Stok</h5><table class="table table-sm" id="tbStok"><thead><tr><th>Depo</th><th>ÃœrÃ¼n</th><th>Miktar</th></tr></thead><tbody></tbody></table></div>
            <div class="card p-3"><h5>Zimmet</h5><table class="table table-sm" id="tbZim"><thead><tr><th>Personel</th><th>ÃœrÃ¼n</th><th>Miktar</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div class="tab-pane fade" id="p4">
            <div class="card p-4 text-center">
                <h3>ğŸ¤– Asistan</h3>
                <input id="aiQ" class="form-control mb-2" placeholder="Sor...">
                <button onclick="ai()" class="btn btn-primary">Sor</button>
                <div id="aiRes" class="alert alert-secondary mt-3 text-start">...</div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "/api"; const v = id => document.getElementById(id).value;
    
    async function login() {
        try {
            let res = await fetch(API+'/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({kadi:v('uName'), sifre:v('uPass')})});
            if(res.ok) { document.getElementById('loginPage').style.display='none'; document.getElementById('mainPage').style.display='block'; init(); }
            else document.getElementById('lMsg').innerText = "HatalÄ± GiriÅŸ!";
        } catch(e) { alert("Sunucu HatasÄ±"); }
    }

    async function init() {
        let b = await(await fetch(API+'/list/bolum')).json();
        let p = await(await fetch(API+'/list/personel')).json();
        let u = await(await fetch(API+'/list/urun')).json();
        
        fill('iBol', b, 'id', 'ad'); fill('zBol', b, 'id', 'ad');
        fill('iUrun', u, 'id', 'ad'); fill('zUrun', u, 'id', 'ad');
        fill('zPer', p, 'id', 'ad_soyad');
    }
    
    function fill(id, arr, val, txt) { document.getElementById(id).innerHTML = arr.map(x=>`<option value="${x[val]}">${x[txt]}</option>`).join(''); }

    async function add(path, data) {
        let r = await fetch(API+'/ekle/'+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(r.ok) { alert("Eklendi"); init(); } else alert("Hata");
    }

    async function hareket() {
        let r = await fetch(API+'/hareket', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tip:v('iTip'), urun_id:v('iUrun'), bolum_id:v('iBol'), miktar:v('iMik')})});
        if(r.ok) alert("Tamam"); else alert((await r.json()).detail);
    }

    async function zimmet() {
        let r = await fetch(API+'/zimmet', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({urun_id:v('zUrun'), personel_id:v('zPer'), bolum_id:v('zBol'), miktar:v('zMik')})});
        if(r.ok) alert("Zimmetlendi"); else alert((await r.json()).detail);
    }

    async function xls() {
        let fd = new FormData(); fd.append("file", document.getElementById('xls').files[0]);
        let r = await fetch(API+'/admin/excel', {method:'POST', body:fd});
        alert((await r.json()).msg); init();
    }

    async function loadRep() {
        let d = await(await fetch(API+'/rapor')).json();
        document.querySelector('#tbStok tbody').innerHTML = d.stok.map(x=>`<tr><td>${x.bolum}</td><td>${x.urun}</td><td>${x.mevcut}</td></tr>`).join('');
        document.querySelector('#tbZim tbody').innerHTML = d.zimmet.map(x=>`<tr><td>${x.ad_soyad}</td><td>${x.urun}</td><td>${x.miktar}</td></tr>`).join('');
    }

    async function ai() {
        document.getElementById('aiRes').innerText = "...";
        let r = await fetch(API+'/ai', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({soru:v('aiQ')})});
        document.getElementById('aiRes').innerText = (await r.json()).cevap;
    }
</script>
</body>
</html>