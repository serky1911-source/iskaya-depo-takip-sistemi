<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Depo V11 Enterprise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .login-container { max-width: 400px; margin: 100px auto; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn-logout { position: absolute; right: 20px; top: 20px; }
    </style>
</head>
<body>

<div id="loginScreen" class="container login-container">
    <div class="card p-4">
        <h3 class="text-center mb-4">üîí Depo Giri≈ü</h3>
        <div class="mb-3">
            <label>Kullanƒ±cƒ± Adƒ±</label>
            <input type="text" id="kadi" class="form-control" placeholder="admin">
        </div>
        <div class="mb-3">
            <label>≈ûifre</label>
            <input type="password" id="sifre" class="form-control" placeholder="admin123">
        </div>
        <button onclick="girisYap()" class="btn btn-primary w-100">Giri≈ü Yap</button>
    </div>
</div>

<div id="mainPanel" class="container-fluid p-4" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üè≠ Depo Y√∂netim Sistemi <span class="badge bg-secondary" id="rolBadge"></span></h2>
        <button onclick="location.reload()" class="btn btn-danger btn-sm">√áƒ±kƒ±≈ü</button>
    </div>

    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabTan" type="button">üõ†Ô∏è Tanƒ±mlamalar</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabIslem" type="button">üì¶ ƒ∞≈ülemler</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabRapor" type="button" onclick="raporGetir()">üìä Raporlar</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAI" type="button">ü§ñ AI Asistan</button></li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="tabTan">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>B√∂l√ºm Ekle</h5>
                        <input id="tBolum" class="form-control mb-2" placeholder="√ñrn: Ana Depo">
                        <button onclick="ekle('bolum', {ad:v('tBolum')})" class="btn btn-success w-100">Ekle</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>Personel Ekle</h5>
                        <input id="tPer" class="form-control mb-2" placeholder="√ñrn: Ahmet Yƒ±lmaz">
                        <button onclick="ekle('personel', {ad:v('tPer')})" class="btn btn-success w-100">Ekle</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>√úr√ºn Tanƒ±mla</h5>
                        <input id="uAd" class="form-control mb-2" placeholder="√úr√ºn Adƒ±">
                        <input id="uSku" class="form-control mb-2" placeholder="SKU">
                        <div class="row g-2 mb-2">
                            <div class="col"><input id="uBirim" class="form-control" placeholder="Birim"></div>
                            <div class="col"><input id="uGuv" type="number" class="form-control" placeholder="G√ºv. Stok"></div>
                        </div>
                        <select id="uTur" class="form-select mb-2">
                            <option value="Sarf">Sarf Malzeme</option>
                            <option value="Demirba≈ü">Demirba≈ü</option>
                        </select>
                        <button onclick="ekle('urun', {ad:v('uAd'), sku:v('uSku'), birim:v('uBirim'), tur:v('uTur'), guvenlik:v('uGuv')})" class="btn btn-primary w-100">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tabIslem">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 border-primary">
                        <h5 class="text-primary">üì• Giri≈ü / üì§ √áƒ±kƒ±≈ü</h5>
                        <select id="hTip" class="form-select mb-2"><option value="GIRIS">Mal Kabul (Giri≈ü)</option><option value="CIKIS">T√ºketim (√áƒ±kƒ±≈ü)</option></select>
                        <select id="hUrun" class="form-select mb-2"><option>√úr√ºn Y√ºkleniyor...</option></select>
                        <select id="hBolum" class="form-select mb-2"><option>Depo Y√ºkleniyor...</option></select>
                        <input id="hMiktar" type="number" class="form-control mb-2" placeholder="Miktar">
                        <input id="hAcik" class="form-control mb-2" placeholder="A√ßƒ±klama">
                        <button onclick="hareketYap()" class="btn btn-primary w-100">Onayla</button>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card p-3 border-warning">
                        <h5 class="text-warning">üöö Transfer</h5>
                        <select id="trUrun" class="form-select mb-2"></select>
                        <div class="row g-2">
                            <div class="col"><select id="trCikis" class="form-select mb-2"><option>Kaynak</option></select></div>
                            <div class="col"><select id="trGiris" class="form-select mb-2"><option>Hedef</option></select></div>
                        </div>
                        <input id="trMiktar" type="number" class="form-control mb-2" placeholder="Miktar">
                        <button onclick="transferYap()" class="btn btn-warning w-100 text-white">Transfer Et</button>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card p-3 border-danger">
                        <h5 class="text-danger">üë∑ Zimmet (Demirba≈ü)</h5>
                        <select id="zUrun" class="form-select mb-2"></select>
                        <select id="zBolum" class="form-select mb-2"><option>Hangi Depodan?</option></select>
                        <select id="zPer" class="form-select mb-2"><option>Kime?</option></select>
                        <input id="zMiktar" type="number" class="form-control mb-2" value="1">
                        <button onclick="zimmetYap()" class="btn btn-danger w-100">Zimmetle</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tabRapor">
            <button onclick="raporGetir()" class="btn btn-secondary mb-3">üîÑ Tablolarƒ± Yenile</button>
            <div class="card p-3">
                <h5 class="text-success">üì¶ G√ºncel Stok Durumu</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tblStok">
                        <thead class="table-dark"><tr><th>Depo</th><th>√úr√ºn</th><th>SKU</th><th>T√ºr</th><th>Miktar</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="card p-3 mt-3">
                <h5 class="text-info">üë∑ Zimmet Listesi</h5>
                <div class="table-responsive">
                    <table class="table table-striped" id="tblZimmet">
                        <thead class="table-dark"><tr><th>Personel</th><th>√úr√ºn</th><th>Adet</th><th>Tarih</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tabAI">
            <div class="card p-4 text-center">
                <h3>ü§ñ Depo Asistanƒ±</h3>
                <div class="input-group mb-3">
                    <input type="text" id="aiQ" class="form-control" placeholder="Soru sor...">
                    <button class="btn btn-primary" onclick="askAI()">Sor</button>
                </div>
                <div id="aiRes" class="alert alert-secondary text-start" style="white-space: pre-wrap;">...</div>
            </div>
        </div>

    </div>
</div>

<script>
    const API = "/api";
    const v = (id) => document.getElementById(id).value;

    async function girisYap() {
        try {
            let res = await fetch(API+'/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({kadi:v('kadi'), sifre:v('sifre')})});
            let d = await res.json();
            if(d.ok) {
                document.getElementById('loginScreen').style.display='none';
                document.getElementById('mainPanel').style.display='block';
                document.getElementById('rolBadge').innerText = d.rol.toUpperCase();
                verileriYukle();
            } else alert("Hatalƒ± Giri≈ü!");
        } catch(e) { alert("Baƒülantƒ± hatasƒ±!"); }
    }

    async function verileriYukle() {
        let b = await (await fetch(API+'/list/bolum')).json();
        let p = await (await fetch(API+'/list/personel')).json();
        let u = await (await fetch(API+'/list/urun')).json();

        fill('hBolum', b, 'id', 'ad'); fill('trCikis', b, 'id', 'ad'); fill('trGiris', b, 'id', 'ad'); fill('zBolum', b, 'id', 'ad');
        fill('hUrun', u, 'id', 'ad'); fill('trUrun', u, 'id', 'ad'); fill('zUrun', u, 'id', 'ad');
        fill('zPer', p, 'id', 'ad_soyad');
    }

    function fill(id, data, val, txt) {
        let el = document.getElementById(id); el.innerHTML = '<option value="">Se√ßiniz...</option>';
        data.forEach(i => el.innerHTML += `<option value="${i[val]}">${i[txt]}</option>`);
    }

    async function ekle(tip, data) {
        let res = await fetch(API+'/ekle/'+tip, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(res.ok) { alert("Ba≈üarƒ±lƒ±!"); verileriYukle(); } else alert("Hata!");
    }

    async function hareketYap() {
        let body = {tip:v('hTip'), urun_id:v('hUrun'), bolum_id:v('hBolum'), miktar:v('hMiktar'), aciklama:v('hAcik')};
        let res = await fetch(API+'/hareket', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) alert("ƒ∞≈ülem Kaydedildi"); else alert((await res.json()).detail);
    }

    async function transferYap() {
        let body = {urun_id:v('trUrun'), cikis_id:v('trCikis'), giris_id:v('trGiris'), miktar:v('trMiktar')};
        let res = await fetch(API+'/transfer', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) alert("Transfer Ba≈üarƒ±lƒ±"); else alert((await res.json()).detail);
    }

    async function zimmetYap() {
        let body = {urun_id:v('zUrun'), personel_id:v('zPer'), bolum_id:v('zBolum'), miktar:v('zMiktar')};
        let res = await fetch(API+'/zimmet', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) alert("Zimmetlendi"); else alert((await res.json()).detail);
    }

    async function raporGetir() {
        let s = await (await fetch(API+'/rapor/stok')).json();
        let h1 = "";
        s.forEach(x => {
            h1 += `<tr><td>${x.bolum}</td><td>${x.urun}</td><td>${x.sku}</td><td>${x.tur}</td><td>${x.mevcut}</td></tr>`;
        });
        document.querySelector('#tblStok tbody').innerHTML = h1 || "<tr><td colspan='5'>Veri Yok</td></tr>";

        let z = await (await fetch(API+'/rapor/zimmet')).json();
        let h2 = "";
        z.forEach(x => h2 += `<tr><td>${x.ad_soyad}</td><td>${x.urun}</td><td>${x.miktar}</td><td>${new Date(x.tarih).toLocaleDateString()}</td></tr>`);
        document.querySelector('#tblZimmet tbody').innerHTML = h2 || "<tr><td colspan='4'>Veri Yok</td></tr>";
    }

    async function askAI() {
        document.getElementById('aiRes').innerText = "D√º≈ü√ºn√ºyor...";
        let res = await fetch(API+'/ai', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({soru:v('aiQ')})});
        document.getElementById('aiRes').innerText = (await res.json()).cevap;
    }
</script>

</body>
</html>