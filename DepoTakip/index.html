<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo V10 Enterprise</title>
    <style>
        :root { --p: #2c3e50; --s: #34495e; --a: #3498db; --d: #e74c3c; --g: #27ae60; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* Gƒ∞Rƒ∞≈û */
        #Login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--p); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .box { background: white; padding: 40px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--a); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-red { background: var(--d); } .btn-green { background: var(--g); }
        
        /* PANEL */
        #Panel { display: none; max-width: 1100px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; }
        header { background: var(--p); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; }
        
        /* SEKMELER */
        .tabs { display: flex; background: #ddd; }
        .tabs button { background: transparent; color: #555; padding: 15px; margin: 0; border-radius: 0; flex: 1; }
        .tabs button.active { background: white; color: var(--a); border-top: 3px solid var(--a); }
        .page { display: none; padding: 20px; }
        .active-page { display: block; }
        
        /* Lƒ∞STELER */
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--s); color: white; }
        .del-btn { padding: 5px 10px; font-size: 0.8rem; background: var(--d); width: auto; }
        
        /* MOBƒ∞L */
        @media(max-width: 600px) { .row { flex-direction: column; } .tabs { flex-wrap: wrap; } }
    </style>
</head>
<body>

<div id="Login">
    <div class="box">
        <h2>üîí Giri≈ü</h2>
        <input type="text" id="uName" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input type="password" id="uPass" placeholder="≈ûifre">
        <button onclick="login()">Giri≈ü Yap</button>
    </div>
</div>

<div id="Panel">
    <header>
        <h1>üè≠ Depo V10</h1>
        <button onclick="location.reload()" style="width: auto; padding: 8px 15px; background: var(--d); font-size: 0.8rem;">√áƒ±kƒ±≈ü</button>
    </header>
    
    <div class="tabs">
        <button onclick="tab('pTan')" class="active">üõ†Ô∏è Tanƒ±mlamalar</button>
        <button onclick="tab('pIsl')">üì¶ ƒ∞≈ülemler</button>
        <button onclick="tab('pRap')">üìä Raporlar</button>
        <button onclick="tab('pAI')">ü§ñ Asistan</button>
    </div>

    <div id="pTan" class="page active-page">
        <div class="row">
            <div class="col card">
                <h3>B√∂l√ºm Y√∂netimi</h3>
                <input id="tBolum" placeholder="Yeni B√∂l√ºm Adƒ±">
                <button onclick="add('bolumler', {ad: v('tBolum')})">Ekle</button>
                <div id="listBolum"></div>
            </div>
            <div class="col card">
                <h3>Personel Y√∂netimi</h3>
                <input id="tPer" placeholder="Ad Soyad">
                <button onclick="add('personel', {ad_soyad: v('tPer')})">Ekle</button>
                <div id="listPer"></div>
            </div>
        </div>
        <div class="card">
            <h3>√úr√ºn Tanƒ±mla & Liste</h3>
            <div class="row">
                <input id="tUrun" placeholder="√úr√ºn Adƒ±">
                <input id="tSku" placeholder="SKU (Barkod)">
                <input id="tBirim" placeholder="Birim">
            </div>
            <div class="row">
                <select id="tTur"><option value="Sarf">Sarf Malzeme</option><option value="Demirba≈ü">Demirba≈ü</option></select>
                <input type="number" id="tGuv" placeholder="G√ºvenlik Stoƒüu">
                <button onclick="add('urunler', {ad:v('tUrun'), sku:v('tSku'), birim:v('tBirim'), tur:v('tTur'), guvenlik_stogu:v('tGuv')})">√úr√ºn√º Kaydet</button>
            </div>
            <div style="margin-top:10px; max-height:200px; overflow-y:auto;" id="listUrun"></div>
        </div>
        <div class="card" style="border: 2px dashed #27ae60;">
            <h3>üì• Excel Y√ºkle</h3>
            <input type="file" id="xlsFile">
            <button class="btn-green" onclick="uploadXls()">Y√ºklemeyi Ba≈ülat</button>
        </div>
    </div>

    <div id="pIsl" class="page">
        <div class="card">
            <h3>Hareket ƒ∞≈ülemi (Giri≈ü / √áƒ±kƒ±≈ü)</h3>
            <select id="iIslem"><option value="giris">Mal Kabul (Giri≈ü)</option><option value="cikis">T√ºketim (√áƒ±kƒ±≈ü)</option></select>
            <div class="row">
                <select id="iUrun"><option>√úr√ºn Se√ß...</option></select>
                <select id="iBolum"><option>B√∂l√ºm Se√ß...</option></select>
            </div>
            <input type="number" id="iMiktar" placeholder="Miktar">
            <input id="iAciklama" placeholder="A√ßƒ±klama / Belge No">
            <button onclick="doIslem()">Onayla</button>
        </div>
        <div class="row">
            <div class="col card">
                <h3>Transfer</h3>
                <select id="trUrun"><option>√úr√ºn...</option></select>
                <select id="trCikis"><option>Kaynak Depo</option></select>
                <select id="trGiris"><option>Hedef Depo</option></select>
                <input type="number" id="trMiktar" placeholder="Miktar">
                <button onclick="doTransfer()">Transfer Et</button>
            </div>
            <div class="col card">
                <h3>Zimmetleme</h3>
                <select id="zUrun"><option>√úr√ºn...</option></select>
                <select id="zBolum"><option>Hangi Depodan?</option></select>
                <select id="zPer"><option>Kime?</option></select>
                <input type="number" id="zMiktar" placeholder="Adet">
                <button class="btn-red" onclick="doZimmet()">Zimmet Ver</button>
            </div>
        </div>
    </div>

    <div id="pRap" class="page">
        <button class="btn-green" onclick="loadReports()">üîÑ Raporlarƒ± Yenile</button>
        <div class="card">
            <h3>üì¶ G√ºncel Stok Durumu</h3>
            <table id="tblStok"><thead><tr><th>B√∂l√ºm</th><th>√úr√ºn</th><th>SKU</th><th>Miktar</th><th>Durum</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
            <h3>üë∑ Zimmet Listesi</h3>
            <table id="tblZimmet"><thead><tr><th>Personel</th><th>√úr√ºn</th><th>Miktar</th><th>Tarih</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="pAI" class="page">
        <div class="card" style="text-align:center;">
            <h3>ü§ñ Depo Asistanƒ±</h3>
            <input id="aiQ" placeholder="Soru sor (√ñrn: Depoda ka√ß matkap var?)">
            <button onclick="askAI()" style="background:#673ab7; margin-top:10px;">Sor</button>
            <div id="aiRes" style="margin-top:20px; text-align:left; background:#eee; padding:15px; border-radius:5px;">Cevap bekleniyor...</div>
        </div>
    </div>
</div>

<script>
    const API = "/api";
    const v = (id) => document.getElementById(id).value;
    
    // --- Gƒ∞Rƒ∞≈û ---
    async function login() {
        try {
            let res = await fetch(API+'/auth/login', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({kadi:v('uName'), sifre:v('uPass')})
            });
            if(res.ok) {
                document.getElementById('Login').style.display='none';
                document.getElementById('Panel').style.display='block';
                init();
            } else alert("Hatalƒ± Giri≈ü!");
        } catch(e) { alert("Sunucu Hatasƒ±: " + e); }
    }

    // --- Y√úKLEMELER ---
    async function init() {
        await loadLists();
        await loadReports();
    }

    async function loadLists() {
        let bol = await (await fetch(API+'/data/bolumler')).json();
        let per = await (await fetch(API+'/data/personel')).json();
        let uru = await (await fetch(API+'/data/urunler')).json();

        // Listeleri Doldur (Tanƒ±mlamalar Ekranƒ±)
        renderList('listBolum', bol, 'bolumler', 'ad');
        renderList('listPer', per, 'personel', 'ad_soyad');
        renderList('listUrun', uru, 'urunler', 'ad', 'sku');

        // Selectleri Doldur
        fillSel('iBolum', bol, 'id', 'ad'); fillSel('trCikis', bol, 'id', 'ad'); fillSel('trGiris', bol, 'id', 'ad'); fillSel('zBolum', bol, 'id', 'ad');
        fillSel('iUrun', uru, 'sku', 'ad'); fillSel('trUrun', uru, 'sku', 'ad'); fillSel('zUrun', uru, 'sku', 'ad');
        fillSel('zPer', per, 'id', 'ad_soyad');
    }

    function renderList(divId, data, apiPath, field, subField=null) {
        let h = '<table>';
        data.forEach(item => {
            h += `<tr><td>${item[field]} ${subField ? ' <small>('+item[subField]+')</small>' : ''}</td>
                  <td style="text-align:right;"><button class="del-btn" onclick="del('${apiPath}', ${item.id})">Sil</button></td></tr>`;
        });
        document.getElementById(divId).innerHTML = h + '</table>';
    }

    function fillSel(id, data, valKey, txtKey) {
        let el = document.getElementById(id); el.innerHTML = '<option value="">Se√ßiniz...</option>';
        data.forEach(item => el.innerHTML += `<option value="${item[valKey]}">${item[txtKey]}</option>`);
    }

    // --- ƒ∞≈ûLEMLER (CRUD) ---
    async function add(path, data) {
        let res = await fetch(API+'/'+path, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(res.ok) { alert("Eklendi"); loadLists(); } else alert("Hata!");
    }

    async function del(path, id) {
        if(!confirm("Silmek istediƒüine emin misin?")) return;
        await fetch(API+'/'+path+'/'+id, {method:'DELETE'});
        loadLists();
    }

    async function doIslem() {
        let type = v('iIslem');
        let data = {sku:v('iUrun'), bolum_id:parseInt(v('iBolum')), miktar:parseFloat(v('iMiktar')), aciklama:v('iAciklama')};
        let res = await fetch(API+'/islem/'+type, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(res.ok) alert("ƒ∞≈ülem Ba≈üarƒ±lƒ±"); else alert("Hata olu≈ütu");
    }

    async function doTransfer() {
        let data = {sku:v('trUrun'), cikis_bolum_id:v('trCikis'), giris_bolum_id:v('trGiris'), miktar:v('trMiktar')};
        let res = await fetch(API+'/islem/transfer', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(res.ok) alert("Transfer Tamam");
    }

    async function doZimmet() {
        let data = {sku:v('zUrun'), bolum_id:v('zBolum'), personel_id:v('zPer'), miktar:v('zMiktar')};
        let res = await fetch(API+'/islem/zimmet', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        if(res.ok) alert("Zimmetlendi");
    }

    async function uploadXls() {
        let f = document.getElementById('xlsFile').files[0];
        if(!f) return alert("Dosya se√ß!");
        let fd = new FormData(); fd.append("file", f);
        alert("Y√ºkleniyor, bekleyin...");
        let res = await fetch(API+'/admin/excel', {method:'POST', body:fd});
        let d = await res.json();
        alert(d.msg || d.detail); loadLists();
    }

    // --- RAPOR ---
    async function loadReports() {
        let stok = await (await fetch(API+'/rapor/stok')).json();
        let html = "";
        stok.forEach(s => {
            html += `<tr><td>${s.bolum_adi}</td><td>${s.urun_adi}</td><td>${s.sku}</td><td><b>${s.mevcut}</b></td><td>${s.tur}</td></tr>`;
        });
        document.querySelector('#tblStok tbody').innerHTML = html || "<tr><td colspan='5'>Veri Yok</td></tr>";

        let zim = await (await fetch(API+'/rapor/zimmet')).json();
        let h2 = "";
        zim.forEach(z => {
            h2 += `<tr><td>${z.ad_soyad}</td><td>${z.urun_adi}</td><td>${z.miktar}</td><td>${new Date(z.tarih).toLocaleDateString()}</td></tr>`;
        });
        document.querySelector('#tblZimmet tbody').innerHTML = h2 || "<tr><td colspan='4'>Veri Yok</td></tr>";
    }

    // --- AI ---
    async function askAI() {
        document.getElementById('aiRes').innerText = "D√º≈ü√ºn√ºyor...";
        let res = await fetch(API+'/ai/sor', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({soru:v('aiQ')})});
        let d = await res.json();
        document.getElementById('aiRes').innerText = d.cevap;
    }

    // --- TAB KONTROL ---
    function tab(id) {
        document.querySelectorAll('.page').forEach(p => p.style.display='none');
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display='block';
        event.currentTarget.classList.add('active');
    }
</script>

</body>
</html>