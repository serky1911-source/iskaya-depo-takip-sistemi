<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo Takip Pro V5.1 (Diplomatik)</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --light: #ecf0f1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f3; margin: 0; padding: 20px; color: #333; }
        
        /* GÄ°RÄ°Å EKRANI */
        #LoginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-box h2 { color: var(--primary); margin-bottom: 20px; }

        /* ANA EKRAN */
        #Dashboard { display: none; }
        
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 10px; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        h2 { color: var(--secondary); font-size: 1.2rem; margin-top: 20px; border-left: 5px solid var(--accent); padding-left: 10px; }
        
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        input:focus, select:focus { border-color: var(--accent); outline: none; }
        button { background-color: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #2980b9; transform: translateY(-2px); }
        .btn-danger { background-color: var(--danger); }
        .btn-logout { background-color: var(--danger); width: auto; font-size: 0.8rem; padding: 8px 15px; }

        /* Ã–ZEL ETÄ°KETLER */
        .badge-manager { background-color: #e1f5fe; color: #0277bd; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; border: 1px solid #81d4fa; display: none; }
        
        /* GÄ°ZLENECEK ALANLAR (DÃ¼zeltildi) */
        .admin-only { display: block; /* Hata vermemesi iÃ§in varsayÄ±lan deÄŸer atadÄ±k */ }

        .tab { overflow: hidden; background-color: var(--primary); border-radius: 8px 8px 0 0; display: flex; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 15px 20px; transition: 0.3s; color: white; width: auto; flex-grow: 1; border-radius: 0; margin: 0; }
        .tab button:hover { background-color: var(--secondary); }
        .tab button.active { background-color: var(--accent); }
        .tabcontent { display: none; padding: 20px; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; animation: fadeEffect 0.5s; background: #fff; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .kritik-stok { background-color: #ffcccc !important; color: #a00; font-weight: bold; }
        .search-box { padding: 10px; width: 100%; border: 2px solid var(--accent); margin-bottom: 10px; }

        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
        .flex-row { display: flex; gap: 10px; }
        .flex-col { flex: 1; }
    </style>
</head>
<body>

<div id="LoginScreen">
    <div class="login-box">
        <h2>ğŸ”’ GÃ¼venli GiriÅŸ</h2>
        <input type="text" id="kullaniciAdi" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="sifre" placeholder="Åifre">
        <button onclick="girisYap()">GiriÅŸ Yap</button>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
            Demo Hesaplar:<br>Admin: <b>admin / admin123</b><br>MÃ¼dÃ¼r: <b>mudur / mudur123</b>
        </p>
    </div>
</div>

<div id="Dashboard">
    <div class="container">
        <h1>
            <span>ğŸ­ Depo YÃ¶netim Paneli <span id="viewBadge" class="badge-manager">ğŸ‘ï¸ YÃ¶netici Modu</span></span>
            <button class="btn-logout" onclick="cikisYap()">Ã‡Ä±kÄ±ÅŸ (<span id="aktifKullanici"></span>)</button>
        </h1>

        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Tanimlamalar')" id="defaultOpen">ğŸ› ï¸ TanÄ±mlamalar</button>
            <button class="tablinks" onclick="openTab(event, 'StokIslem')">ğŸ“¦ Stok GiriÅŸ/Ã‡Ä±kÄ±ÅŸ</button>
            <button class="tablinks" onclick="openTab(event, 'TransferZimmet')">ğŸšš Transfer & Zimmet</button>
            <button class="tablinks" onclick="openTab(event, 'Raporlar')">ğŸ“Š Raporlar</button>
        </div>

        <div id="Tanimlamalar" class="tabcontent">
            <div id="mudurDashboard1" style="display:none; text-align:center; padding: 20px;">
                <h3>ğŸ“‹ Sistem KayÄ±tlarÄ±</h3>
                <p>AÅŸaÄŸÄ±daki butonlara tÄ±klayarak mevcut kayÄ±tlarÄ± inceleyebilirsiniz.</p>
                <div class="flex-row">
                     <button style="background:#34495e;" onclick="listeGoster('bolum')">ğŸ¢ BÃ¶lÃ¼m Listesi</button>
                     <button style="background:#34495e;" onclick="listeGoster('personel')">ğŸ‘· Personel Listesi</button>
                     <button style="background:#34495e;" onclick="listeGoster('urun')">ğŸ“¦ ÃœrÃ¼n Listesi</button>
                </div>
                <div id="basitListe" style="margin-top:15px; text-align:left; max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:15px; border-radius:5px; background:#f9f9f9;">
                    <i>GÃ¶rÃ¼ntÃ¼lemek istediÄŸiniz listeyi seÃ§iniz...</i>
                </div>
            </div>

            <div class="admin-only">
                <div class="flex-row">
                    <div class="flex-col">
                        <h2>BÃ¶lÃ¼m/Depo Ekle</h2>
                        <input type="text" id="yeniBolumAdi" placeholder="Ã–rn: Kaynak AtÃ¶lyesi">
                        <button onclick="bolumEkle()">BÃ¶lÃ¼m Kaydet</button>
                    </div>
                    <div class="flex-col">
                        <h2>Personel Ekle</h2>
                        <input type="text" id="yeniPersonelAdi" placeholder="Ã–rn: Ahmet YÄ±lmaz">
                        <button onclick="personelEkle()">Personel Kaydet</button>
                    </div>
                </div>
                <hr>
                <h2>ÃœrÃ¼n TanÄ±mla</h2>
                <div class="flex-row">
                    <input type="text" id="yeniUrunAdi" placeholder="ÃœrÃ¼n AdÄ±">
                    <input type="text" id="yeniSku" placeholder="SKU/Barkod">
                    <input type="text" id="yeniBirim" placeholder="Birim" style="width: 30%;">
                </div>
                <div class="flex-row">
                    <select id="yeniTur">
                        <option value="Sarf">Sarf Malzeme</option>
                        <option value="DemirbaÅŸ">DemirbaÅŸ</option>
                    </select>
                    <input type="number" id="yeniGuvenlik" placeholder="GÃ¼venlik StoÄŸu">
                    <button onclick="urunEkle()">ÃœrÃ¼nÃ¼ Sisteme Ä°ÅŸle</button>
                </div>
            </div>
        </div>

        <div id="StokIslem" class="tabcontent">
            <div class="admin-only">
                <h2>Mal Kabul veya TÃ¼ketim</h2>
                <label>Ä°ÅŸlem TÃ¼rÃ¼:</label>
                <select id="islemTuru">
                    <option value="giris">Mal Kabul (GiriÅŸ)</option>
                    <option value="cikis">TÃ¼ketim (Ã‡Ä±kÄ±ÅŸ)</option>
                </select>
                <div class="flex-row">
                    <select id="islemBolumId" class="flex-col"><option>BÃ¶lÃ¼m SeÃ§iniz...</option></select>
                    <select id="islemUrunSku" class="flex-col"><option>ÃœrÃ¼n SeÃ§iniz...</option></select>
                </div>
                <input type="number" id="islemMiktar" placeholder="Miktar">
                <input type="text" id="islemBelge" placeholder="Belge No / AÃ§Ä±klama">
                <button onclick="stokIslemYap()">Ä°ÅŸlemi Onayla</button>
            </div>

            <div id="mudurDashboard2" style="display:none; text-align:center; padding:40px;">
                <h2 style="color:#7f8c8d;">ğŸ“¦ Stok OperasyonlarÄ±</h2>
                <p>Bu ekran depo sorumlusu tarafÄ±ndan veri giriÅŸi (Mal Kabul / Sevkiyat) yapÄ±lmasÄ± iÃ§indir.</p>
                <p>GÃ¼ncel stok hareketlerini <b>"Raporlar"</b> sekmesinden canlÄ± olarak takip edebilirsiniz.</p>
                <button onclick="openTab({currentTarget: document.querySelector('.tab button:last-child')}, 'Raporlar')" style="width:50%; margin-top:20px;">ğŸ“Š Raporlara Git</button>
            </div>
        </div>

        <div id="TransferZimmet" class="tabcontent">
            <div class="admin-only">
                <div class="flex-row">
                    <div class="flex-col" style="border-right: 1px solid #ddd; padding-right: 15px;">
                        <h2 style="color: var(--accent);">ğŸ”„ Depolar ArasÄ± Transfer</h2>
                        <select id="trUrun"><option>ÃœrÃ¼n SeÃ§...</option></select>
                        <label>Nereden?</label>
                        <select id="trCikisBolum"><option>Kaynak Depo...</option></select>
                        <label>Nereye?</label>
                        <select id="trGirisBolum"><option>Hedef Depo...</option></select>
                        <input type="number" id="trMiktar" placeholder="Miktar">
                        <button onclick="transferYap()">Transfer Et</button>
                    </div>
                    <div class="flex-col" style="padding-left: 15px;">
                        <h2 style="color: var(--danger);">ğŸ‘· Zimmetleme</h2>
                        <select id="zimUrun"><option>ÃœrÃ¼n SeÃ§...</option></select>
                        <select id="zimBolum"><option>Depo SeÃ§...</option></select>
                        <select id="zimPersonel"><option>Personel SeÃ§...</option></select>
                        <input type="number" id="zimMiktar" value="1" placeholder="Adet">
                        <button class="btn-danger" onclick="zimmetVer()">Zimmetle</button>
                    </div>
                </div>
            </div>

             <div id="mudurDashboard3" style="display:none; text-align:center; padding:40px;">
                <h2 style="color:#7f8c8d;">ğŸ”„ Transfer ve Zimmet OperasyonlarÄ±</h2>
                <p>Bu bÃ¶lÃ¼mdeki iÅŸlemler yetkili depo personeli tarafÄ±ndan yÃ¼rÃ¼tÃ¼lmektedir.</p>
                <p>Mevcut zimmet durumlarÄ±nÄ± incelemek iÃ§in aÅŸaÄŸÄ±daki butonu kullanabilirsiniz.</p>
                <button onclick="zimmetRaporuGetir(); openTab({currentTarget: document.querySelector('.tab button:last-child')}, 'Raporlar')" style="width:50%; margin-top:20px; background-color:var(--secondary);">ğŸ‘· Zimmet Listesini Ä°ncele</button>
            </div>
        </div>

        <div id="Raporlar" class="tabcontent">
            <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3>ğŸ” DetaylÄ± Sorgulama</h3>
                <div class="flex-row">
                    <div class="flex-col"><label>BaÅŸlangÄ±Ã§:</label><input type="date" id="rapBaslangic"></div>
                    <div class="flex-col"><label>BitiÅŸ:</label><input type="date" id="rapBitis"></div>
                    <div class="flex-col"><label>Depo:</label><select id="rapBolum"><option value="0">TÃ¼m Depolar</option></select></div>
                    <div class="flex-col" style="display: flex; align-items: flex-end;"><button onclick="hareketRaporuGetir()" style="background-color: var(--primary);">ğŸ“œ Hareket DÃ¶kÃ¼mÃ¼</button></div>
                </div>
            </div>
            <div class="flex-row">
                <button onclick="stokRaporuGetir()">ğŸ“¦ AnlÄ±k Stok</button>
                <button onclick="zimmetRaporuGetir()" style="background-color: var(--secondary);">ğŸ‘· Zimmet Listesi</button>
            </div>
            <input type="text" id="tabloArama" class="search-box" onkeyup="tabloFiltrele()" placeholder="Tabloda ara...">
            <table id="raporTablosu"><thead></thead><tbody></tbody></table>
        </div>
    </div>
</div>

<script>
    // BULUT Ä°Ã‡Ä°N BOÅ BIRAK (Otomatik algÄ±lar)
    const API_URL = "";

    async function girisYap() {
        const kAdi = document.getElementById('kullaniciAdi').value;
        const sifre = document.getElementById('sifre').value;

        try {
            const response = await fetch(`${API_URL}/giris`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ kullanici_adi: kAdi, sifre: sifre })
            });

            if (response.ok) {
                const data = await response.json();
                
                document.getElementById('LoginScreen').style.display = 'none';
                document.getElementById('Dashboard').style.display = 'block';
                document.getElementById('aktifKullanici').innerText = data.ad;

                // --- DÄ°PLOMATÄ°K MOD AYARLARI ---
                if (data.rol === 'izleyici') {
                    // 1. YÃ¶netici Rozetini GÃ¶ster
                    document.getElementById('viewBadge').style.display = 'inline-block';

                    // 2. Veri GiriÅŸ AlanlarÄ±nÄ± Gizle (Sessizce)
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                    
                    // 3. MÃ¼dÃ¼r Ä°Ã§in HazÄ±rlanan Ã–zel Bilgi EkranlarÄ±nÄ± AÃ§
                    document.getElementById('mudurDashboard1').style.display = 'block';
                    document.getElementById('mudurDashboard2').style.display = 'block';
                    document.getElementById('mudurDashboard3').style.display = 'block';
                    
                    // 4. DoÄŸrudan Raporlar Sekmesini AÃ§
                    openTab({currentTarget: document.querySelector('.tab button:last-child')}, 'Raporlar');
                } else {
                    document.getElementById("defaultOpen").click();
                }

                sayfaYukle();
            } else {
                alert("HatalÄ± KullanÄ±cÄ± AdÄ± veya Åifre!");
            }
        } catch (error) {
            alert("Sunucuya baÄŸlanÄ±lamadÄ±! main.py aÃ§Ä±k mÄ±?");
        }
    }

    function cikisYap() { location.reload(); }

    async function listeGoster(tip) {
        let url = '';
        if(tip==='bolum') url='/bolumler/listele';
        if(tip==='personel') url='/personel/listele';
        if(tip==='urun') url='/urunler/listele';
        
        const data = await getData(url);
        let html = "<ul style='list-style-type:circle; padding-left:20px;'>";
        data.forEach(item => {
            if(tip==='bolum') html += `<li><b>${item.bolum_adi}</b></li>`;
            if(tip==='personel') html += `<li>${item.ad_soyad}</li>`;
            if(tip==='urun') html += `<li>${item.urun_adi} <span style='color:#777; font-size:0.8em'>(${item.SKU})</span></li>`;
        });
        html += "</ul>";
        document.getElementById('basitListe').innerHTML = html;
    }

    // --- STANDART FONKSÄ°YONLAR ---
    async function postData(url, data) {
        const response = await fetch(`${API_URL}${url}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if (response.ok) { alert("Ä°ÅŸlem BaÅŸarÄ±lÄ±! âœ…"); sayfaYukle(); } else { const err = await response.json(); alert("HATA: " + err.detail); }
    }
    async function getData(url) { const response = await fetch(`${API_URL}${url}`); return await response.json(); }

    function bolumEkle() { postData('/bolumler/ekle', { bolum_adi: document.getElementById('yeniBolumAdi').value }); }
    function personelEkle() { postData('/personel/ekle', { ad_soyad: document.getElementById('yeniPersonelAdi').value }); }
    function urunEkle() { postData('/urunler/ekle', { urun_adi: document.getElementById('yeniUrunAdi').value, sku: document.getElementById('yeniSku').value, birim: document.getElementById('yeniBirim').value, tur: document.getElementById('yeniTur').value, guvenlik_stogu: parseInt(document.getElementById('yeniGuvenlik').value) }); }
    function stokIslemYap() { const tur = document.getElementById('islemTuru').value; postData(`/stok/${tur}`, { sku: document.getElementById('islemUrunSku').value, bolum_id: parseInt(document.getElementById('islemBolumId').value), miktar: parseFloat(document.getElementById('islemMiktar').value), belge_no: document.getElementById('islemBelge').value }); }
    function transferYap() { postData('/stok/transfer', { sku: document.getElementById('trUrun').value, cikis_bolum_id: parseInt(document.getElementById('trCikisBolum').value), giris_bolum_id: parseInt(document.getElementById('trGirisBolum').value), miktar: parseFloat(document.getElementById('trMiktar').value) }); }
    function zimmetVer() { postData('/zimmet/ver', { sku: document.getElementById('zimUrun').value, personel_id: parseInt(document.getElementById('zimPersonel').value), bolum_id: parseInt(document.getElementById('zimBolum').value), miktar: parseFloat(document.getElementById('zimMiktar').value) }); }

    async function hareketRaporuGetir() {
        const veri = { baslangic_tarihi: document.getElementById('rapBaslangic').value, bitis_tarihi: document.getElementById('rapBitis').value, bolum_id: parseInt(document.getElementById('rapBolum').value) };
        const data = await (await fetch(`${API_URL}/rapor/hareketler`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(veri) })).json();
        const tbody = document.querySelector('#raporTablosu tbody'); document.querySelector('#raporTablosu thead').innerHTML = `<tr><th>Tarih</th><th>Ä°ÅŸlem</th><th>Depo</th><th>ÃœrÃ¼n</th><th>Miktar</th><th>AÃ§Ä±klama</th></tr>`; tbody.innerHTML = "";
        if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>KayÄ±t yok.</td></tr>"; return; }
        data.forEach(row => { const renk = row.islem_tipi === 'GÄ°RÄ°Å' ? '#eafaf1' : '#fdedec'; tbody.innerHTML += `<tr style="background-color:${renk}"><td>${new Date(row.tarih).toLocaleString('tr-TR')}</td><td>${row.islem_tipi}</td><td>${row.bolum_adi}</td><td>${row.urun_adi}</td><td>${row.miktar}</td><td>${row.aciklama}</td></tr>`; });
    }
    async function stokRaporuGetir() {
        const data = await getData('/rapor/genel-stok'); const tbody = document.querySelector('#raporTablosu tbody'); document.querySelector('#raporTablosu thead').innerHTML = `<tr><th>BÃ¶lÃ¼m</th><th>ÃœrÃ¼n</th><th>SKU</th><th>Tip</th><th>Stok</th><th>UyarÄ±</th></tr>`; tbody.innerHTML = "";
        data.forEach(row => { const cls = row.uyari ? 'kritik-stok' : ''; tbody.innerHTML += `<tr class="${cls}"><td>${row.bolum_adi}</td><td>${row.urun_adi}</td><td>${row.SKU}</td><td>${row.tur}</td><td>${row.mevcut_stok}</td><td>${row.uyari ? 'ğŸš¨ KRÄ°TÄ°K' : 'âœ…'}</td></tr>`; });
    }
    async function zimmetRaporuGetir() {
        const data = await getData('/rapor/zimmetler'); const tbody = document.querySelector('#raporTablosu tbody'); document.querySelector('#raporTablosu thead').innerHTML = `<tr><th>Tarih</th><th>Personel</th><th>ÃœrÃ¼n</th><th>SKU</th><th>Adet</th></tr>`; tbody.innerHTML = "";
        data.forEach(row => { tbody.innerHTML += `<tr><td>${new Date(row.verilis_tarihi).toLocaleString('tr-TR')}</td><td>${row.ad_soyad}</td><td>${row.urun_adi}</td><td>${row.SKU}</td><td>${row.miktar}</td></tr>`; });
    }
    function tabloFiltrele() { var filter = document.getElementById("tabloArama").value.toUpperCase(); var tr = document.getElementById("raporTablosu").getElementsByTagName("tr"); for (var i = 0; i < tr.length; i++) { if (tr[i].innerText.toUpperCase().indexOf(filter) > -1) tr[i].style.display = ""; else if(i!==0) tr[i].style.display = "none"; } }

    async function sayfaYukle() {
        const today = new Date().toISOString().split('T')[0]; document.getElementById('rapBaslangic').value = today; document.getElementById('rapBitis').value = today;
        const bolumler = await getData('/bolumler/listele'); const urunler = await getData('/urunler/listele'); const personeller = await getData('/personel/listele');
        const setOpts = (id, data, valField, textField, defText) => { const el = document.getElementById(id); if(!el) return; el.innerHTML = `<option value="">${defText}</option>`; data.forEach(d => el.innerHTML += `<option value="${d[valField]}">${d[textField]}</option>`); };
        setOpts('islemBolumId', bolumler, 'bolum_id', 'bolum_adi', 'BÃ¶lÃ¼m SeÃ§...'); setOpts('trCikisBolum', bolumler, 'bolum_id', 'bolum_adi', 'BÃ¶lÃ¼m SeÃ§...'); setOpts('trGirisBolum', bolumler, 'bolum_id', 'bolum_adi', 'BÃ¶lÃ¼m SeÃ§...'); setOpts('zimBolum', bolumler, 'bolum_id', 'bolum_adi', 'BÃ¶lÃ¼m SeÃ§...');
        setOpts('islemUrunSku', urunler, 'SKU', 'urun_adi', 'ÃœrÃ¼n SeÃ§...'); setOpts('trUrun', urunler, 'SKU', 'urun_adi', 'ÃœrÃ¼n SeÃ§...'); setOpts('zimUrun', urunler, 'SKU', 'urun_adi', 'ÃœrÃ¼n SeÃ§...');
        setOpts('zimPersonel', personeller, 'personel_id', 'ad_soyad', 'Personel SeÃ§...');
        const rapBolum = document.getElementById('rapBolum'); rapBolum.innerHTML = '<option value="0">TÃ¼m Depolar</option>'; bolumler.forEach(b => rapBolum.innerHTML += `<option value="${b.bolum_id}">${b.bolum_adi}</option>`);
    }
    function openTab(evt, tabName) { var i, tabcontent, tablinks; tabcontent = document.getElementsByClassName("tabcontent"); for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; } tablinks = document.getElementsByClassName("tablinks"); for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); } document.getElementById(tabName).style.display = "block"; if(evt.currentTarget) evt.currentTarget.className += " active"; }
</script>

</body>
</html>